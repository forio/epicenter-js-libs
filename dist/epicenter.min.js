(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
!function(){function InvalidCharacterError(message){this.message=message}var object="undefined"!=typeof exports?exports:self;var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";InvalidCharacterError.prototype=new Error,InvalidCharacterError.prototype.name="InvalidCharacterError",object.btoa||(object.btoa=function(input){var str=String(input);for(var block,charCode,idx=0,map=chars,output="";str.charAt(0|idx)||(map="=",idx%1);output+=map.charAt(63&block>>8-idx%1*8)){if(charCode=str.charCodeAt(idx+=.75),charCode>255)throw new InvalidCharacterError("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");block=block<<8|charCode}return output}),object.atob||(object.atob=function(input){var str=String(input).replace(/=+$/,"");if(str.length%4==1)throw new InvalidCharacterError("'atob' failed: The string to be decoded is not correctly encoded.");for(var bs,buffer,bc=0,idx=0,output="";buffer=str.charAt(idx++);~buffer&&(bs=bc%4?64*bs+buffer:buffer,bc++%4)?output+=String.fromCharCode(255&bs>>(-2*bc&6)):0)buffer=chars.indexOf(buffer);return output})}();
},{}],2:[function(require,module,exports){
"use strict";function toObject(val){if(null===val||void 0===val)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(val)}function shouldUseNative(){try{if(!Object.assign)return!1;var test1=new String("abc");if(test1[5]="de","5"===Object.getOwnPropertyNames(test1)[0])return!1;var test2={};for(var i=0;i<10;i++)test2["_"+String.fromCharCode(i)]=i;var order2=Object.getOwnPropertyNames(test2).map(function(n){return test2[n]});if("0123456789"!==order2.join(""))return!1;var test3={};return"abcdefghijklmnopqrst".split("").forEach(function(letter){test3[letter]=letter}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},test3)).join("")}catch(e){return!1}}var hasOwnProperty=Object.prototype.hasOwnProperty;var propIsEnumerable=Object.prototype.propertyIsEnumerable;module.exports=shouldUseNative()?Object.assign:function(target,source){var from;var to=toObject(target);var symbols;for(var s=1;s<arguments.length;s++){from=Object(arguments[s]);for(var key in from)hasOwnProperty.call(from,key)&&(to[key]=from[key]);if(Object.getOwnPropertySymbols){symbols=Object.getOwnPropertySymbols(from);for(var i=0;i<symbols.length;i++)propIsEnumerable.call(from,symbols[i])&&(to[symbols[i]]=from[symbols[i]])}}return to};
},{}],3:[function(require,module,exports){
module.exports={"version":"v2"}
},{}],4:[function(require,module,exports){
(function (global){
var F={util:{},factory:{},transport:{},store:{},service:{},manager:{strategy:{}}};F.load=require("./env-load"),global.SKIP_ENV_LOAD||F.load(),F.util.query=require("./util/query-util"),F.util.run=require("./util/run-util"),F.util.classFrom=require("./util/inherit"),F.factory.Transport=require("./transport/http-transport-factory"),F.transport.Ajax=require("./transport/ajax-http-transport"),F.service.URL=require("./service/url-config-service"),F.service.Config=require("./service/configuration-service"),F.service.Run=require("./service/run-api-service"),F.service.File=require("./service/admin-file-service"),F.service.Variables=require("./service/variables-api-service"),F.service.Data=require("./service/data-api-service"),F.service.Auth=require("./service/auth-api-service"),F.service.World=require("./service/world-api-adapter"),F.service.State=require("./service/state-api-adapter"),F.service.User=require("./service/user-api-adapter"),F.service.Member=require("./service/member-api-adapter"),F.service.Asset=require("./service/asset-api-adapter"),F.service.Group=require("./service/group-api-service"),F.service.Introspect=require("./service/introspection-api-service"),F.store.Cookie=require("./store/cookie-store"),F.factory.Store=require("./store/store-factory"),F.manager.ScenarioManager=require("./managers/scenario-manager"),F.manager.RunManager=require("./managers/run-manager"),F.manager.AuthManager=require("./managers/auth-manager"),F.manager.WorldManager=require("./managers/world-manager"),F.manager.SavedRunsManager=require("./managers/saved-run-manager");var strategies=require("./managers/run-strategies");F.manager.strategy=strategies.list,F.manager.ChannelManager=require("./managers/epicenter-channel-manager"),F.service.Channel=require("./service/channel-service"),F.version="2.0.1",F.api=require("./api-version.json"),global.F=F,module.exports=F;
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"./api-version.json":3,"./env-load":5,"./managers/auth-manager":6,"./managers/epicenter-channel-manager":8,"./managers/run-manager":10,"./managers/run-strategies":13,"./managers/saved-run-manager":21,"./managers/scenario-manager":22,"./managers/world-manager":26,"./service/admin-file-service":27,"./service/asset-api-adapter":28,"./service/auth-api-service":29,"./service/channel-service":30,"./service/configuration-service":31,"./service/data-api-service":32,"./service/group-api-service":33,"./service/introspection-api-service":34,"./service/member-api-adapter":35,"./service/run-api-service":36,"./service/state-api-adapter":38,"./service/url-config-service":39,"./service/user-api-adapter":40,"./service/variables-api-service":41,"./service/world-api-adapter":42,"./store/cookie-store":43,"./store/store-factory":45,"./transport/ajax-http-transport":46,"./transport/http-transport-factory":47,"./util/inherit":48,"./util/query-util":51,"./util/run-util":52}],5:[function(require,module,exports){
"use strict";var URLConfigService=require("./service/url-config-service");var envLoad=function(callback){var urlService=new URLConfigService;var infoUrl=urlService.getAPIPath("config");var envPromise=$.ajax({url:infoUrl,async:!1});return envPromise=envPromise.then(function(res){var overrides=res.api;URLConfigService.defaults=$.extend(URLConfigService.defaults,overrides)}),envPromise.then(callback).fail(callback)};module.exports=envLoad;
},{"./service/url-config-service":39}],6:[function(require,module,exports){
"use strict";function AuthManager(options){options=$.extend(!0,{},defaults,options),this.sessionManager=new SessionManager(options),this.options=this.sessionManager.getMergedOptions(),this.authAdapter=new AuthAdapter(this.options)}var AuthAdapter=require("../service/auth-api-service");var MemberAdapter=require("../service/member-api-adapter");var GroupService=require("../service/group-api-service");var SessionManager=require("../store/session-manager");var _pick=require("../util/object-util")._pick;var objectAssign=require("object-assign");var atob=window.atob||require("Base64").atob;var defaults={requiresGroup:!0};var _findUserInGroup=function(members,id){for(var j=0;j<members.length;j++)if(members[j].userId===id)return members[j];return null};AuthManager.prototype=$.extend(AuthManager.prototype,{login:function(options){var me=this;var $d=$.Deferred();var sessionManager=this.sessionManager;var adapterOptions=sessionManager.getMergedOptions({success:$.noop,error:$.noop},options);var outSuccess=adapterOptions.success;var outError=adapterOptions.error;var groupId=adapterOptions.groupId;var decodeToken=function(token){var encoded=token.split(".")[1];for(;encoded.length%4!==0;)encoded+="=";return JSON.parse(atob(encoded))};var handleGroupError=function(message,statusCode,data){me.logout().then(function(){var error=$.extend(!0,{},data,{statusText:message,status:statusCode});$d.reject(error)})};var handleSuccess=function(response){var token=response.access_token;var userInfo=decodeToken(token);var oldGroups=sessionManager.getSession(adapterOptions).groups||{};var userGroupOpts=$.extend(!0,{},adapterOptions,{success:$.noop});var data={auth:response,user:userInfo};var project=adapterOptions.project;var isTeamMember=null===userInfo.parent_account_id;var requiresGroup=adapterOptions.requiresGroup&&project;var sessionInfo={auth_token:token,account:adapterOptions.account,project:project,userId:userInfo.user_id,groups:oldGroups,isTeamMember:isTeamMember};if(!requiresGroup)return sessionManager.saveSession(sessionInfo),outSuccess.apply(this,[data]),void $d.resolve(data);var handleGroupList=function(groupList){data.userGroups=groupList;var group=null;if(0===groupList.length)return void handleGroupError("The user has no groups associated in this account",401,data);if(1===groupList.length)group=groupList[0];else if(groupList.length>1&&groupId){var filteredGroups=$.grep(groupList,function(resGroup){return resGroup.groupId===groupId});group=1===filteredGroups.length?filteredGroups[0]:null}if(group){var isFac=!!isTeamMember||"facilitator"===_findUserInGroup(group.members,userInfo.user_id).role;var groupData={groupId:group.groupId,groupName:group.name,isFac:isFac};var sessionInfoWithGroup=objectAssign({},sessionInfo,groupData);sessionInfo.groups[project]=groupData,me.sessionManager.saveSession(sessionInfoWithGroup,adapterOptions),outSuccess.apply(this,[data]),$d.resolve(data)}else handleGroupError("This user is associated with more than one group. Please specify a group id to log into and try again",403,data)};if(isTeamMember){var opts=objectAssign({},userGroupOpts,{token:token});var groupService=new GroupService(opts);groupService.getGroups({account:adapterOptions.account,project:project}).then(function(groups){groups.forEach(function(group){group.groupId=group.id}),handleGroupList(groups)},$d.reject)}else me.getUserGroups({userId:userInfo.user_id,token:token},userGroupOpts).then(handleGroupList,$d.reject)};return adapterOptions.success=handleSuccess,adapterOptions.error=function(response){return adapterOptions.account?(adapterOptions.account=null,adapterOptions.error=function(){outError.apply(this,arguments),$d.reject(response)},void me.authAdapter.login(adapterOptions)):(outError.apply(this,arguments),void $d.reject(response))},this.authAdapter.login(adapterOptions),$d.promise()},logout:function(options){var me=this;var adapterOptions=this.sessionManager.getMergedOptions(options);var removeCookieFn=function(response){me.sessionManager.removeSession()};return this.authAdapter.logout(adapterOptions).then(removeCookieFn)},getToken:function(options){var httpOptions=this.sessionManager.getMergedOptions(options);var session=this.sessionManager.getSession(httpOptions);var $d=$.Deferred();return session.auth_token?$d.resolve(session.auth_token):this.login(httpOptions).then($d.resolve),$d.promise()},getUserGroups:function(params,options){var adapterOptions=this.sessionManager.getMergedOptions({success:$.noop},options);var $d=$.Deferred();var outSuccess=adapterOptions.success;adapterOptions.success=function(memberInfo){adapterOptions.project&&(memberInfo=$.grep(memberInfo,function(group){return group.project===adapterOptions.project})),outSuccess.apply(this,[memberInfo]),$d.resolve(memberInfo)};var memberAdapter=new MemberAdapter({token:params.token,server:adapterOptions.server});return memberAdapter.getGroupsForUser(params,adapterOptions).fail($d.reject),$d.promise()},getCurrentUserSessionInfo:function(options){var adapterOptions=this.sessionManager.getMergedOptions({success:$.noop},options);return this.sessionManager.getSession(adapterOptions)},addGroups:function(groups){var session=this.getCurrentUserSessionInfo();var isArray=Array.isArray(groups);return groups=isArray?groups:[groups],$.each(groups,function(index,group){var extendedGroup=$.extend({},{isFac:!1},group);var project=extendedGroup.project;var validProps=["groupName","groupId","isFac"];if(!project||!extendedGroup.groupName)throw new Error("No project or groupName specified.");extendedGroup=_pick(extendedGroup,validProps),session.groups[project]=extendedGroup}),this.sessionManager.saveSession(session),session}}),module.exports=AuthManager;
},{"../service/auth-api-service":29,"../service/group-api-service":33,"../service/member-api-adapter":35,"../store/session-manager":44,"../util/object-util":49,"Base64":1,"object-assign":2}],7:[function(require,module,exports){
"use strict";var Channel=require("../service/channel-service");var SessionManager=require("../store/session-manager");var ChannelManager=function(options){if(!$.cometd)throw new Error("Cometd library not found. Please include epicenter-multiplayer-dependencies.js");if(!options||!options.url)throw new Error("Please provide an url for the cometd server");var defaults={url:"",logLevel:"info",websocketEnabled:!0,ackEnabled:!0,shareConnection:!1,channel:{},handshake:void 0};this.sessionManager=new SessionManager;var defaultCometOptions=this.sessionManager.getMergedOptions(defaults,options);if(this.currentSubscriptions=[],this.options=defaultCometOptions,defaultCometOptions.shareConnection&&ChannelManager.prototype._cometd)return this.cometd=ChannelManager.prototype._cometd,this;var cometd=new $.CometD;ChannelManager.prototype._cometd=cometd,cometd.websocketEnabled=defaultCometOptions.websocketEnabled,cometd.ackEnabled=defaultCometOptions.ackEnabled,this.isConnected=!1;var connectionBroken=function(message){$(this).trigger("disconnect",message)};var connectionSucceeded=function(message){$(this).trigger("connect",message)};var me=this;cometd.configure(defaultCometOptions),cometd.addListener("/meta/connect",function(message){var wasConnected=this.isConnected;this.isConnected=message.successful===!0,!wasConnected&&this.isConnected?connectionSucceeded.call(this,message):wasConnected&&!this.isConnected&&connectionBroken.call(this,message)}.bind(this)),cometd.addListener("/meta/disconnect",connectionBroken),cometd.addListener("/meta/handshake",function(message){message.successful&&cometd.batch(function(){$(me.currentSubscriptions).each(function(index,subs){cometd.resubscribe(subs)})})}),cometd.addListener("/meta/subscribe",function(message){$(me).trigger("subscribe",message)}),cometd.addListener("/meta/unsubscribe",function(message){$(me).trigger("unsubscribe",message)}),cometd.addListener("/meta/publish",function(message){$(me).trigger("publish",message)}),cometd.addListener("/meta/unsuccessful",function(message){$(me).trigger("error",message)}),cometd.handshake(defaultCometOptions.handshake),this.cometd=cometd};ChannelManager.prototype=$.extend(ChannelManager.prototype,{getChannel:function(options){options&&!$.isPlainObject(options)&&(options={base:options});var defaults={transport:this.cometd};var channel=new Channel($.extend(!0,{},this.options.channel,defaults,options));var subs=channel.subscribe;channel.subscribe=function(){var subid=subs.apply(channel,arguments);return this.currentSubscriptions=this.currentSubscriptions.concat(subid),subid}.bind(this);var unsubs=channel.unsubscribe;return channel.unsubscribe=function(){var removed=unsubs.apply(channel,arguments);for(var i=0;i<this.currentSubscriptions.length;i++)this.currentSubscriptions[i].id===removed.id&&this.currentSubscriptions.splice(i,1);return removed}.bind(this),channel},on:function(event){$(this).on.apply($(this),arguments)},off:function(event){$(this).off.apply($(this),arguments)},trigger:function(event){$(this).trigger.apply($(this),arguments)}}),module.exports=ChannelManager;
},{"../service/channel-service":30,"../store/session-manager":44}],8:[function(require,module,exports){
"use strict";var ChannelManager=require("./channel-manager");var classFrom=require("../util/inherit");var urlService=require("../service/url-config-service");var SessionManager=require("../store/session-manager");var validTypes={project:!0,group:!0,world:!0,user:!0,data:!0,general:!0,chat:!0};var getFromSessionOrError=function(value,sessionKeyName,settings){if(!value){if(!settings||!settings[sessionKeyName])throw new Error(sessionKeyName+" not found. Please log-in again, or specify "+sessionKeyName+" explicitly");value=settings[sessionKeyName]}return value};var __super=ChannelManager.prototype;var EpicenterChannelManager=classFrom(ChannelManager,{constructor:function(options){this.sessionManager=new SessionManager(options);var defaultCometOptions=this.sessionManager.getMergedOptions(options);var urlOpts=urlService(defaultCometOptions.server);if(defaultCometOptions.url||(defaultCometOptions.url=urlOpts.protocol+"://"+urlOpts.host+"/channel/subscribe"),void 0===defaultCometOptions.handshake){var userName=defaultCometOptions.userName;var userId=defaultCometOptions.userId;var token=defaultCometOptions.token;if((userName||userId)&&token){var userProp=userName?"userName":"userId";var ext={authorization:"Bearer "+token};ext[userProp]=userName?userName:userId,defaultCometOptions.handshake={ext:ext}}}return this.options=defaultCometOptions,__super.constructor.call(this,defaultCometOptions)},getChannel:function(options){options&&"object"!=typeof options&&(options={base:options});var channelOpts=$.extend({},this.options,options);var base=channelOpts.base;if(!base)throw new Error("No base topic was provided");if(!channelOpts.allowAllChannels){var baseParts=base.split("/");var channelType=baseParts[1];if(baseParts.length<4)throw new Error("Invalid channel base name, it must be in the form /{type}/{account id}/{project id}/{...}");if(!validTypes[channelType])throw new Error("Invalid channel type")}return __super.getChannel.apply(this,arguments)},getGroupChannel:function(groupName){var session=this.sessionManager.getMergedOptions(this.options);groupName=getFromSessionOrError(groupName,"groupName",session);var account=getFromSessionOrError("","account",session);var project=getFromSessionOrError("","project",session);var baseTopic=["/group",account,project,groupName].join("/");return __super.getChannel.call(this,{base:baseTopic})},getWorldChannel:function(world,groupName){var worldid=$.isPlainObject(world)&&world.id?world.id:world;if(!worldid)throw new Error("Please specify a world id");var session=this.sessionManager.getMergedOptions(this.options);groupName=getFromSessionOrError(groupName,"groupName",session);var account=getFromSessionOrError("","account",session);var project=getFromSessionOrError("","project",session);var baseTopic=["/world",account,project,groupName,worldid].join("/");return __super.getChannel.call(this,{base:baseTopic})},getUserChannel:function(world,user,groupName){var worldid=$.isPlainObject(world)&&world.id?world.id:world;if(!worldid)throw new Error("Please specify a world id");var session=this.sessionManager.getMergedOptions(this.options);var userid=$.isPlainObject(user)&&user.id?user.id:user;userid=getFromSessionOrError(userid,"userId",session),groupName=getFromSessionOrError(groupName,"groupName",session);var account=getFromSessionOrError("","account",session);var project=getFromSessionOrError("","project",session);var baseTopic=["/user",account,project,groupName,worldid,userid].join("/");return __super.getChannel.call(this,{base:baseTopic})},getPresenceChannel:function(world,userid,groupName){var worldid=$.isPlainObject(world)&&world.id?world.id:world;if(!worldid)throw new Error("Please specify a world id");var session=this.sessionManager.getMergedOptions(this.options);userid=getFromSessionOrError(userid,"userId",session),groupName=getFromSessionOrError(groupName,"groupName",session);var account=getFromSessionOrError("","account",session);var project=getFromSessionOrError("","project",session);var baseTopic=["/user",account,project,groupName,worldid].join("/");var channel=__super.getChannel.call(this,{base:baseTopic});var lastPingTime={};var PING_INTERVAL=6e3;return channel.subscribe("internal-ping-channel",function(notification){var incomingUserId=notification.data.user;lastPingTime[incomingUserId]||incomingUserId===userid||channel.trigger("presence",{userId:incomingUserId,online:!0}),lastPingTime[incomingUserId]=(new Date).valueOf()}),setInterval(function(){channel.publish("internal-ping-channel",{user:userid}),$.each(lastPingTime,function(key,value){var now=(new Date).valueOf();value&&value+2*PING_INTERVAL<now&&(lastPingTime[key]=null,channel.trigger("presence",{userId:key,online:!1}))})},PING_INTERVAL),channel},getDataChannel:function(collection){if(!collection)throw new Error("Please specify a collection to listen on.");var session=this.sessionManager.getMergedOptions(this.options);var account=getFromSessionOrError("","account",session);var project=getFromSessionOrError("","project",session);var baseTopic=["/data",account,project,collection].join("/");var channel=__super.getChannel.call(this,{base:baseTopic});var oldsubs=channel.subscribe;return channel.subscribe=function(topic,callback,context,options){var callbackWithCleanData=function(payload){var meta={path:payload.channel,subType:payload.data.subType,date:payload.data.date};var actualData=payload.data.data;actualData.data&&(actualData=actualData.data),callback.call(context,actualData,meta)};return oldsubs.call(channel,topic,callbackWithCleanData,context,options)},channel}});module.exports=EpicenterChannelManager;
},{"../service/url-config-service":39,"../store/session-manager":44,"../util/inherit":48,"./channel-manager":7}],9:[function(require,module,exports){
"use strict";module.exports={EPI_SESSION_KEY:"epicenterjs.session",STRATEGY_SESSION_KEY:"epicenter-scenario"};
},{}],10:[function(require,module,exports){
"use strict";function patchRunService(service,manager){if(service.patched)return service;var orig=service.do;return service.do=function(operation,params,options){var reservedOps=Object.keys(specialOperations);return reservedOps.indexOf(operation)===-1?orig.apply(service,arguments):specialOperations[operation].call(service,params,options,manager)},service.patched=!0,service}function setRunInSession(sessionKey,runid,sessionManager){sessionKey&&sessionManager.getStore().set(sessionKey,JSON.stringify({runId:runid}))}function RunManager(options){if(this.options=$.extend(!0,{},defaults,options),this.options.run instanceof RunService)this.run=this.options.run;else{if(!this.options.run)throw new Error("No run options passed to RunManager");this.run=new RunService(this.options.run)}patchRunService(this.run,this);var StrategyCtor="function"==typeof this.options.strategy?this.options.strategy:strategies.get(this.options.strategy);if(!StrategyCtor)throw new Error("Specified run creation strategy was invalid:",this.options.strategy);var strategy=new StrategyCtor(this.options);if(!strategy.getRun||!strategy.reset)throw new Error("All strategies should implement a `getRun` and `reset` interface",this.options.strategy);strategy.requiresAuth=StrategyCtor.requiresAuth,this.strategy=strategy,this.sessionManager=new SessionManager(this.options)}var strategies=require("./run-strategies");var specialOperations=require("./special-operations");var RunService=require("../service/run-api-service");var SessionManager=require("../store/session-manager");var util=require("../util/object-util");var keyNames=require("./key-names");var defaults={sessionKey:keyNames.STRATEGY_SESSION_KEY,strategy:"new-if-initialized"};RunManager.prototype={getRun:function(variables,options){var me=this;var sessionStore=this.sessionManager.getStore();var runSession=JSON.parse(sessionStore.get(this.options.sessionKey)||"{}");var runid=runSession&&runSession.runId;var authSession=this.sessionManager.getSession();return this.strategy.requiresAuth&&util.isEmpty(authSession)?(console.error("No user-session available",this.options.strategy,"requires authentication."),$.Deferred().reject("No user-session available").promise()):this.strategy.getRun(this.run,authSession,runid,options).then(function(run){return run&&run.id&&(setRunInSession(me.options.sessionKey,run.id,me.sessionManager),me.run.updateConfig({filter:run.id}),variables&&variables.length)?me.run.variables().query(variables).then(function(results){return run.variables=results,run}).catch(function(err){return run.variables={},console.error(err),run}):run})},reset:function(options){var me=this;var authSession=this.sessionManager.getSession();return this.strategy.requiresAuth&&util.isEmpty(authSession)?(console.error("No user-session available",this.options.strategy,"requires authentication."),$.Deferred().reject("No user-session available").promise()):this.strategy.reset(this.run,authSession,options).then(function(run){return run&&run.id&&(setRunInSession(me.options.sessionKey,run.id,me.sessionManager),me.run.updateConfig({filter:run.id})),run})}},RunManager.strategies=strategies,module.exports=RunManager;
},{"../service/run-api-service":36,"../store/session-manager":44,"../util/object-util":49,"./key-names":9,"./run-strategies":13,"./special-operations":25}],11:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(options){__super.constructor.call(this,this.createIf,options)},createIf:function(run,headers){return!0}});module.exports=Strategy;
},{"../../util/inherit":48,"./conditional-creation-strategy":12}],12:[function(require,module,exports){
"use strict";var Base=require("./none-strategy");var classFrom=require("../../util/inherit");var Strategy=classFrom(Base,{constructor:function(condition){if(null==condition)throw new Error("Conditional strategy needs a condition to create a run");this.condition="function"!=typeof condition?function(){return condition}:condition},reset:function(runService,userSession,options){var group=userSession&&userSession.groupName;var opt=$.extend({scope:{group:group}},runService.getCurrentConfig());return runService.create(opt,options).then(function(run){return run.freshlyCreated=!0,run})},getRun:function(runService,userSession,runIdInSession,options){var me=this;return runIdInSession?this.loadAndCheck(runService,userSession,runIdInSession,options).catch(function(){return me.reset(runService,userSession,options)}):this.reset(runService,userSession,options)},loadAndCheck:function(runService,userSession,runIdInSession,options){var shouldCreate=!1;var me=this;return runService.load(runIdInSession,null,{success:function(run,msg,headers){shouldCreate=me.condition(run,headers)}}).then(function(run){return shouldCreate?me.reset(runService,userSession,options):run})}});module.exports=Strategy;
},{"../../util/inherit":48,"./none-strategy":18}],13:[function(require,module,exports){
var list={"new-if-initialized":require("./new-if-initialized-strategy"),"new-if-persisted":require("./new-if-persisted-strategy"),"new-if-missing":require("./new-if-missing-strategy"),"always-new":require("./always-new-strategy"),multiplayer:require("./multiplayer-strategy"),"persistent-single-player":require("./persistent-single-player-strategy"),none:require("./none-strategy"),baseline:require("../scenario-strategies/baseline-strategy"),"new-if-stepped":require("../scenario-strategies/last-unsaved"),"conditional-creation":require("./conditional-creation-strategy"),"reuse-last-initialized":require("./reuse-last-initialized")};module.exports={list:list,get:function(strategyName){return list[strategyName]},register:function(name,strategy,options){strategy.options=options,list[name]=strategy}};
},{"../scenario-strategies/baseline-strategy":23,"../scenario-strategies/last-unsaved":24,"./always-new-strategy":11,"./conditional-creation-strategy":12,"./multiplayer-strategy":14,"./new-if-initialized-strategy":15,"./new-if-missing-strategy":16,"./new-if-persisted-strategy":17,"./none-strategy":18,"./persistent-single-player-strategy":19,"./reuse-last-initialized":20}],14:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var IdentityStrategy=require("./none-strategy");var WorldApiAdapter=require("../../service/world-api-adapter");var defaults={};var Strategy=classFrom(IdentityStrategy,{constructor:function(options){this.options=$.extend(!0,{},defaults,options),this.worldApi=new WorldApiAdapter(this.options.run)},reset:function(runService,session){var curUserId=session.userId;var curGroupName=session.groupName;return this.worldApi.getCurrentWorldForUser(curUserId,curGroupName).then(function(world){return this.worldApi.newRunForWorld(world.id)}.bind(this))},getRun:function(runService,session){var curUserId=session.userId;var curGroupName=session.groupName;var worldApi=this.worldApi;var model=this.options.model;var me=this;var dtd=$.Deferred();if(!curUserId)return dtd.reject({statusCode:400,error:"We need an authenticated user to join a multiplayer world. (ERR: no userId in session)"},session).promise();var loadRunFromWorld=function(world){return world?worldApi.getCurrentRunId({model:model,filter:world.id}).then(function(id){return runService.load(id)}).then(dtd.resolve).fail(dtd.reject):dtd.reject({statusCode:404,error:"The user is not in any world."},{options:me.options,session:session})};var serverError=function(error){return dtd.reject(error,session,me.options)};return this.worldApi.getCurrentWorldForUser(curUserId,curGroupName).then(loadRunFromWorld).fail(serverError),dtd.promise()}});module.exports=Strategy;
},{"../../service/world-api-adapter":42,"../../util/inherit":48,"./none-strategy":18}],15:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(options){__super.constructor.call(this,this.createIf,options),console.warn("This strategy is deprecated; all runs now default to being initialized by default making this redundant. Consider using `reuse-last-initialized` instead.")},createIf:function(run,headers){return"persistent"===headers.getResponseHeader("pragma")||run.initialized}});module.exports=Strategy;
},{"../../util/inherit":48,"./conditional-creation-strategy":12}],16:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(options){__super.constructor.call(this,this.createIf,options)},createIf:function(run,headers){return!1}});module.exports=Strategy;
},{"../../util/inherit":48,"./conditional-creation-strategy":12}],17:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(options){__super.constructor.call(this,this.createIf,options)},createIf:function(run,headers){return"persistent"===headers.getResponseHeader("pragma")}});module.exports=Strategy;
},{"../../util/inherit":48,"./conditional-creation-strategy":12}],18:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var Base={};module.exports=classFrom(Base,{constructor:function(options){},reset:function(){return $.Deferred().resolve().promise()},getRun:function(){return $.Deferred().resolve(this.runService).promise()}});
},{"../../util/inherit":48}],19:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var IdentityStrategy=require("./none-strategy");var StateApi=require("../../service/state-api-adapter");var defaults={};var Strategy=classFrom(IdentityStrategy,{constructor:function(options){this.options=$.extend(!0,{},defaults,options),this.stateApi=new StateApi},reset:function(runService,userSession,options){var group=userSession.groupName;var opt=$.extend({scope:{group:group}},runService.getCurrentConfig());return runService.create(opt,options).then(function(run){return run.freshlyCreated=!0,run})},getRun:function(runService,userSession,runIdInSession,options){var me=this;var params={"scope.group":userSession.groupName};return userSession.userId&&(params["user.id"]=userSession.userId),runService.query(params).then(function(runs){return me._loadAndCheck(runService,userSession,runs,options)})},_loadAndCheck:function(runService,userSession,runs,options){if(!runs||!runs.length)return this.reset(runService,userSession,options);var dateComp=function(a,b){return new Date(b.date)-new Date(a.date)};var latestRun=runs.sort(dateComp)[0];var me=this;var shouldReplay=!1;return runService.load(latestRun.id,null,{success:function(run,msg,headers){shouldReplay="persistent"===headers.getResponseHeader("pragma")}}).then(function(run){return shouldReplay?me.stateApi.replay({runId:run.id}).then(function(resp){return runService.load(resp)}):run})}},{requiresAuth:!0});module.exports=Strategy;
},{"../../service/state-api-adapter":38,"../../util/inherit":48,"./none-strategy":18}],20:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var Base={};var defaults={initOperation:[],flag:null};module.exports=classFrom(Base,{constructor:function(options){if(this.options=$.extend(!0,{},defaults,options.strategyOptions),!this.options.initOperation||!this.options.initOperation.length)throw new Error("Specifying an init function is required for this strategy");this.options.flag||(this.options.flag={isInitComplete:!0})},reset:function(runService,userSession,options){var group=userSession&&userSession.groupName;var opt=$.extend({scope:{group:group}},runService.getCurrentConfig());var me=this;return runService.create(opt,options).then(function(createResponse){return runService.serial([].concat(me.options.initOperation)).then(function(){return createResponse})}).then(function(createResponse){return runService.save(me.options.flag).then(function(patchResponse){return $.extend(!0,{},createResponse,patchResponse)})})},getRun:function(runService,userSession,runIdInSession,options){var filter=this.options.flag;userSession&&userSession.groupName&&(filter["scope.group"]=userSession.groupName),userSession&&userSession.userId&&(filter["user.id"]=userSession.userId);var me=this;return runService.filter(filter,{startrecord:0,endrecord:0,sort:"created",direction:"desc"}).then(function(runs){return runs.length?runs[0]:me.reset(runService,userSession,options)})}});
},{"../../util/inherit":48}],21:[function(require,module,exports){
"use strict";var RunService=require("../service/run-api-service");var SessionManager=require("../store/session-manager");var SavedRunsManager=function(config){var defaults={};var options=$.extend(!0,{},defaults,config);if(!options.run)throw new Error("No run options passed to SavedRunsManager");if(options.run instanceof RunService)this.runService=options.run;else{var sm=new SessionManager(options.run);var mergedOpts=sm.getMergedOptions({},options.run);this.runService=new RunService(mergedOpts)}};SavedRunsManager.prototype={mark:function(run,toMark){var rs;if(run instanceof RunService)rs=run;else{if("string"==typeof Run)throw new Error("Invalid run object provided");var existingOptions=this.runService.getCurrentConfig();rs=new RunService($.extend(!0,{},existingOptions,{id:run}))}return rs.save(toMark)},save:function(run,otherFields){var param=$.extend(!0,{},otherFields,{saved:!0,trashed:!1});return this.mark(run,param)},remove:function(run,otherFields){var param=$.extend(!0,{},otherFields,{saved:!1,trashed:!0});return this.mark(run,param)},getRuns:function(variables,filter,options){var actingFilter=$.extend(!0,{},{saved:!0,trashed:!1},filter);var opModifiers={sort:"created",direction:"asc"};var me=this;return this.runService.query(actingFilter,opModifiers).then(function(savedRuns){if(!variables||!variables.length)return savedRuns;var promises=savedRuns.map(function(run){var prom=me.runService.variables().query([].concat(variables),{},{filter:run.id}).then(function(variables){return run.variables=variables,run}).catch(function(err){return err&&console.error(err),run.variables={},run});return prom});return $.when.apply(null,promises).then(function(){return Array.apply(null,arguments)})})}},module.exports=SavedRunsManager;
},{"../service/run-api-service":36,"../store/session-manager":44}],22:[function(require,module,exports){
"use strict";function ScenarioManager(config){var serviceOptions=$.extend(!0,{},defaults,config);this.baseline=new RunManager({strategy:"baseline",sessionKey:"sm-baseline-run",run:serviceOptions.run}),this.current=new RunManager({strategy:"new-if-stepped",sessionKey:"sm-current-run",run:serviceOptions.run});var baseLineProm=this.baseline.getRun();this.savedRuns=new SavedRunsManager({run:serviceOptions.run});var orig=this.savedRuns.getRuns;this.savedRuns.getRuns=function(){var args=Array.apply(null,arguments);var me=this;return baseLineProm.then(function(){return orig.apply(me.savedRuns,args)})}}var RunManager=require("./run-manager");var SavedRunsManager=require("./saved-run-manager");var defaults={baselineRunName:"Baseline"};module.exports=ScenarioManager;
},{"./run-manager":10,"./saved-run-manager":21}],23:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var Base={};var BASELINE_NAME="baseline";module.exports=classFrom(Base,{constructor:function(runService,options){},reset:function(runService,userSession){var group=userSession&&userSession.groupName;var opt=$.extend({scope:{group:group}},runService.getCurrentConfig());return runService.create(opt).then(function(createResponse){return runService.save({saved:!0,trashed:!1,name:BASELINE_NAME}).then(function(patchResponse){return $.extend(!0,{},createResponse,patchResponse)})}).then(function(mergedResponse){return runService.do({stepTo:"end"}).then(function(){return mergedResponse})})},getRun:function(runService,userSession,runIdInSession){var filter={saved:!0,trashed:!1,name:BASELINE_NAME,"scope.group":userSession.groupName};userSession.userId&&(filter["user.id"]=userSession.userId);var me=this;return runService.filter(filter,{startrecord:0,endrecord:0,sort:"created",direction:"desc"}).then(function(runs){return runs.length?runs[0]:me.reset(runService,userSession)})}},{requiresAuth:!0});
},{"../../util/inherit":48}],24:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var StateService=require("../../service/state-api-adapter");var Base={};module.exports=classFrom(Base,{constructor:function(options){},reset:function(runService,userSession){var group=userSession&&userSession.groupName;var opt=$.extend({scope:{group:group}},runService.getCurrentConfig());return runService.create(opt).then(function(createResponse){return runService.save({trashed:!1}).then(function(patchResponse){return $.extend(!0,{},createResponse,patchResponse)})})},getRun:function(runService,userSession){var defaultFilterParams={"scope.group":userSession.groupName};userSession.userId&&(defaultFilterParams["user.id"]=userSession.userId);var filter=$.extend(!0,{},defaultFilterParams,{trashed:!1});var me=this;var outputModifiers={startrecord:0,endrecord:0,sort:"created",direction:"desc"};return runService.filter(filter,outputModifiers).then(function(runs){if(!runs.length)return me.reset(runService,userSession);var lastRun=runs[0];if(lastRun.saved!==!0)return lastRun;var basedOnRunid=lastRun.id;var sa=new StateService;return sa.clone({runId:basedOnRunid,stopBefore:"stepTo"}).then(function(response){return runService.load(response.run)}).then(function(run){return runService.save({trashed:!1}).then(function(patchResponse){return $.extend(!0,{},run,patchResponse)})})})}},{requiresAuth:!0});
},{"../../service/state-api-adapter":38,"../../util/inherit":48}],25:[function(require,module,exports){
"use strict";module.exports={reset:function(params,options,manager){return manager.reset(options)}};
},{}],26:[function(require,module,exports){
"use strict";function buildStrategy(worldId,dtd){return function(options){this.options=options,$.extend(this,{reset:function(){throw new Error("not implementd. Need api changes")},getRun:function(runService){var me=this;var model=this.options.run.model||this.options.model;return worldApi.getCurrentRunId({model:model,filter:worldId}).then(function(runId){return runService.load(runId)}).then(function(run){dtd.resolveWith(me,[run])}).fail(dtd.reject)}})}}var WorldApi=require("../service/world-api-adapter");var RunManager=require("./run-manager");var AuthManager=require("./auth-manager");var worldApi;module.exports=function(options){this.options=options||{run:{},world:{}},$.extend(!0,this.options,this.options.run),$.extend(!0,this.options,this.options.world),worldApi=new WorldApi(this.options),this._auth=new AuthManager;var me=this;var api={getCurrentWorld:function(userId,groupName){var session=this._auth.getCurrentUserSessionInfo();return userId||(userId=session.userId),groupName||(groupName=session.groupName),worldApi.getCurrentWorldForUser(userId,groupName)},getCurrentRun:function(model){function getAndRestoreLatestRun(world){if(!world)return dtd.reject({error:"The user is not part of any world!"});var currentWorldId=world.id;var runOpts=$.extend(!0,me.options,{model:model});var strategy=buildStrategy(currentWorldId,dtd);var opt=$.extend(!0,{},{strategy:strategy,run:runOpts});var rm=new RunManager(opt);return rm.getRun().then(function(run){dtd.resolve(run,rm.runService,rm)})}var dtd=$.Deferred();var session=this._auth.getCurrentUserSessionInfo();var curUserId=session.userId;var curGroupName=session.groupName;return this.getCurrentWorld(curUserId,curGroupName).then(getAndRestoreLatestRun),dtd.promise()}};$.extend(this,api)};
},{"../service/world-api-adapter":42,"./auth-manager":6,"./run-manager":10}],27:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var SessionManager=require("../store/session-manager");module.exports=function(config){function uploadBody(fileName,contents){var boundary="---------------------------7da24f2e50046";return{body:"--"+boundary+'\r\nContent-Disposition: form-data; name="file";filename="'+fileName+'"\r\nContent-type: text/html\r\n\r\n'+contents+"\r\n--"+boundary+"--",boundary:boundary}}function uploadFileOptions(filePath,contents,options){filePath=filePath.split("/");var fileName=filePath.pop();filePath=filePath.join("/");var path=serviceOptions.folderType+"/"+filePath;var upload=uploadBody(fileName,contents);return $.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath("file")+path,data:upload.body,contentType:"multipart/form-data; boundary="+upload.boundary})}var defaults={token:void 0,account:void 0,project:void 0,folderType:"static",transport:{}};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account&&(urlConfig.accountPath=serviceOptions.account),serviceOptions.project&&(urlConfig.projectPath=serviceOptions.project);var httpOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath("file")});serviceOptions.token&&(httpOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(httpOptions);var publicAsyncAPI={getContents:function(filePath,options){var path=serviceOptions.folderType+"/"+filePath;var httpOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath("file")+path});return http.get("",httpOptions)},replace:function(filePath,contents,options){var httpOptions=uploadFileOptions(filePath,contents,options);return http.put(httpOptions.data,httpOptions)},create:function(filePath,contents,replaceExisting,options){var httpOptions=uploadFileOptions(filePath,contents,options);var prom=http.post(httpOptions.data,httpOptions);var me=this;return replaceExisting===!0&&(prom=prom.then(null,function(xhr){var conflictStatus=409;if(xhr.status===conflictStatus)return me.replace(filePath,contents,options)})),prom},remove:function(filePath,options){var path=serviceOptions.folderType+"/"+filePath;var httpOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath("file")+path});return http.delete(null,httpOptions)},rename:function(filePath,newName,options){var path=serviceOptions.folderType+"/"+filePath;var httpOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath("file")+path});return http.patch({name:newName},httpOptions)}};$.extend(this,publicAsyncAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"./configuration-service":31}],28:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var _pick=require("../util/object-util")._pick;var SessionManager=require("../store/session-manager");var apiEndpoint="asset";module.exports=function(config){var defaults={token:void 0,account:void 0,project:void 0,group:void 0,userId:void 0,scope:"user",fullUrl:!0,transport:{processData:!1}};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account||(serviceOptions.account=urlConfig.accountPath),serviceOptions.project||(serviceOptions.project=urlConfig.projectPath);var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions);var assetApiParams=["encoding","data","contentType"];var scopeConfig={user:["scope","account","project","group","userId"],group:["scope","account","project","group"],project:["scope","account","project"]};var validateFilename=function(filename){if(!filename)throw new Error("filename is needed.")};var validateUrlParams=function(options){var partKeys=scopeConfig[options.scope];if(!partKeys)throw new Error("scope parameter is needed.");$.each(partKeys,function(){if(!options[this])throw new Error(this+" parameter is needed.")})};var buildUrl=function(filename,options){validateUrlParams(options);var partKeys=scopeConfig[options.scope];var parts=$.map(partKeys,function(key){return options[key]});return filename&&(filename="/"+filename),urlConfig.getAPIPath(apiEndpoint)+parts.join("/")+filename};var upload=function(method,filename,params,options){validateFilename(filename),method=method.toLowerCase();var contentType=params instanceof FormData!=!0&&"application/json";"application/json"===contentType?params=_pick(params,assetApiParams):filename="post"===method||"put"===method?"":filename;var urlOptions=$.extend({},serviceOptions,options);var url=buildUrl(filename,urlOptions);var createOptions=$.extend(!0,{},urlOptions,{url:url,contentType:contentType});return http[method](params,createOptions)};var publicAPI={create:function(filename,params,options){return upload("post",filename,params,options)},get:function(filename,options){var getServiceOptions=_pick(serviceOptions,["scope","account","project","group","userId"]);var urlOptions=$.extend({},getServiceOptions,options);var url=buildUrl(filename,urlOptions);var getOptions=$.extend(!0,{},urlOptions,{url:url});return http.get({},getOptions)},list:function(options){var dtd=$.Deferred();var me=this;var urlOptions=$.extend({},serviceOptions,options);var url=buildUrl("",urlOptions);var getOptions=$.extend(!0,{},urlOptions,{url:url});var fullUrl=getOptions.fullUrl;return fullUrl?(http.get({},getOptions).then(function(files){var fullPathFiles=$.map(files,function(file){return buildUrl(file,urlOptions)});dtd.resolveWith(me,[fullPathFiles])}).fail(dtd.reject),dtd.promise()):http.get({},getOptions)},replace:function(filename,params,options){return upload("put",filename,params,options)},delete:function(filename,options){return upload("delete",filename,{},options)},assetUrl:function(filename,options){var urlOptions=$.extend({},serviceOptions,options);return buildUrl(filename,urlOptions)}};$.extend(this,publicAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"../util/object-util":49,"./configuration-service":31}],29:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");module.exports=function(config){var defaults={userName:"",password:"",account:"",transport:{}};var serviceOptions=$.extend({},defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath("authentication")});var http=new TransportFactory(transportOptions);var publicAPI={login:function(options){var httpOptions=$.extend(!0,{success:$.noop},serviceOptions,options);if(!httpOptions.userName||!httpOptions.password){var resp={status:401,statusMessage:"No username or password specified."};return options.error&&options.error.call(this,resp),$.Deferred().reject(resp).promise()}var postParams={userName:httpOptions.userName,password:httpOptions.password};return httpOptions.account&&(postParams.account=httpOptions.account),http.post(postParams,httpOptions)},logout:function(options){var dtd=$.Deferred();return dtd.resolve(),dtd.promise()}};$.extend(this,publicAPI)};
},{"../transport/http-transport-factory":47,"./configuration-service":31}],30:[function(require,module,exports){
"use strict";var Channel=function(options){var defaults={base:"",topicResolver:function(topic){return topic},transport:null};this.channelOptions=$.extend(!0,{},defaults,options)};var makeName=function(channelName,topic){var newName=(channelName?channelName+"/"+topic:topic).replace(/\/\//g,"/").replace(/\/$/,"");return newName};Channel.prototype=$.extend(Channel.prototype,{subscribe:function(topic,callback,context,options){var topics=[].concat(topic);var me=this;var subscriptionIds=[];var opts=me.channelOptions;return opts.transport.batch(function(){$.each(topics,function(index,topic){topic=makeName(opts.base,opts.topicResolver(topic)),subscriptionIds.push(opts.transport.subscribe(topic,callback))})}),subscriptionIds[1]?subscriptionIds:subscriptionIds[0]},publish:function(topic,data){var topics=[].concat(topic);var me=this;var returnObjs=[];var opts=me.channelOptions;return opts.transport.batch(function(){$.each(topics,function(index,topic){topic=makeName(opts.base,opts.topicResolver(topic)),"*"===topic.charAt(topic.length-1)&&(topic=topic.replace(/\*+$/,""),console.warn("You can cannot publish to channels with wildcards. Publishing to ",topic,"instead")),returnObjs.push(opts.transport.publish(topic,data))})}),returnObjs[1]?returnObjs:returnObjs[0]},unsubscribe:function(token){return this.channelOptions.transport.unsubscribe(token),this},on:function(event){$(this).on.apply($(this),arguments)},off:function(event){$(this).off.apply($(this),arguments)},trigger:function(event){$(this).trigger.apply($(this),arguments)}}),module.exports=Channel;
},{}],31:[function(require,module,exports){
"use strict";var urlService=require("./url-config-service");module.exports=function(config){var defaults={logLevel:"NONE"};var serviceOptions=$.extend({},defaults,config);return serviceOptions.server=urlService(serviceOptions.server),{data:serviceOptions,setEnv:function(env){},get:function(property){return serviceOptions[property]},set:function(key,value){serviceOptions[key]=value}}};
},{"./url-config-service":39}],32:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var qutil=require("../util/query-util");var TransportFactory=require("../transport/http-transport-factory");var SessionManager=require("../store/session-manager");module.exports=function(config){var defaults={root:"/",account:void 0,project:void 0,token:void 0,transport:{}};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account&&(urlConfig.accountPath=serviceOptions.account),serviceOptions.project&&(urlConfig.projectPath=serviceOptions.project);var getURL=function(key,root){root||(root=serviceOptions.root);var url=urlConfig.getAPIPath("data")+qutil.addTrailingSlash(root);return key&&(url+=qutil.addTrailingSlash(key)),url};var httpOptions=$.extend(!0,{},serviceOptions.transport,{url:getURL});serviceOptions.token&&(httpOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(httpOptions);var publicAPI={query:function(key,query,outputModifier,options){var params=$.extend(!0,{q:query},outputModifier);var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL(key,httpOptions.root),http.get(params,httpOptions)},save:function(key,value,options){var attrs;"object"==typeof key?(attrs=key,options=value):(attrs={})[key]=value;var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL("",httpOptions.root),http.post(attrs,httpOptions)},saveAs:function(key,value,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL(key,httpOptions.root),http.put(value,httpOptions)},load:function(key,outputModifier,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL(key,httpOptions.root),http.get(outputModifier,httpOptions)},remove:function(keys,options){var httpOptions=$.extend(!0,{},serviceOptions,options);var params;return $.isArray(keys)?params={id:keys}:(params="",httpOptions.url=getURL(keys,httpOptions.root)),http.delete(params,httpOptions)}};$.extend(this,publicAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"../util/query-util":51,"./configuration-service":31}],33:[function(require,module,exports){
"use strict";var serviceUtils=require("./service-utils");var TransportFactory=require("../transport/http-transport-factory");var objectAssign=require("object-assign");var apiEndpoint="group/local";var GroupService=function(config){var defaults={account:void 0,project:void 0,transport:{}};var serviceOptions=serviceUtils.getDefaultOptions(defaults,config,{apiEndpoint:apiEndpoint});var transportOptions=serviceOptions.transport;delete serviceOptions.transport;var http=new TransportFactory(transportOptions,serviceOptions);var publicAPI={getGroups:function(params,options){var finalOpts=objectAssign({},serviceOptions,options);var finalParams;return"string"==typeof params?finalOpts.url=serviceUtils.getApiUrl(apiEndpoint+"/"+params,finalOpts):finalParams=params,http.get(finalParams,finalOpts)}};objectAssign(this,publicAPI)};module.exports=GroupService;
},{"../transport/http-transport-factory":47,"./service-utils":37,"object-assign":2}],34:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var SessionManager=require("../store/session-manager");var apiEndpoint="model/introspect";module.exports=function(config){var defaults={token:void 0,account:void 0,project:void 0};var sessionManager=new SessionManager;var serviceOptions=sessionManager.getMergedOptions(defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account&&(urlConfig.accountPath=serviceOptions.account),serviceOptions.project&&(urlConfig.projectPath=serviceOptions.project);var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions);var publicAPI={byModel:function(modelFile,options){var opts=$.extend(!0,{},serviceOptions,options);if(!opts.account||!opts.project)throw new Error("Account and project are required when using introspect#byModel");if(!modelFile)throw new Error("modelFile is required when using introspect#byModel");var url={url:urlConfig.getAPIPath(apiEndpoint)+[opts.account,opts.project,modelFile].join("/")};var httpOptions=$.extend(!0,{},serviceOptions,options,url);return http.get("",httpOptions)},byRunID:function(runID,options){if(!runID)throw new Error("runID is required when using introspect#byModel");var url={url:urlConfig.getAPIPath(apiEndpoint)+runID};var httpOptions=$.extend(!0,{},serviceOptions,options,url);return http.get("",httpOptions)}};$.extend(this,publicAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"./configuration-service":31}],35:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var SessionManager=require("../store/session-manager");var _pick=require("../util/object-util")._pick;var apiEndpoint="member/local";module.exports=function(config){var defaults={userId:void 0,groupId:void 0,transport:{}};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions,serviceOptions);var getFinalParams=function(params){return"object"==typeof params?$.extend(!0,serviceOptions,params):serviceOptions};var patchUserActiveField=function(params,active,options){var httpOptions=$.extend(!0,serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+params.groupId+"/"+params.userId});return http.patch({active:active},httpOptions)};var publicAPI={getGroupsForUser:function(params,options){options=options||{};var httpOptions=$.extend(!0,serviceOptions,options);var isString="string"==typeof params;var objParams=getFinalParams(params);if(!isString&&!objParams.userId)throw new Error("No userId specified.");var getParms=isString?{userId:params}:_pick(objParams,"userId");return http.get(getParms,httpOptions)},getGroupDetails:function(params,options){options=options||{};var isString="string"==typeof params;var objParams=getFinalParams(params);if(!isString&&!objParams.groupId)throw new Error("No groupId specified.");var groupId=isString?params:objParams.groupId;var httpOptions=$.extend(!0,serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+groupId});return http.get({},httpOptions)},makeUserActive:function(params,options){return patchUserActiveField(params,!0,options)},makeUserInactive:function(params,options){return patchUserActiveField(params,!1,options)}};$.extend(this,publicAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"../util/object-util":49,"./configuration-service":31}],36:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var qutil=require("../util/query-util");var rutil=require("../util/run-util");var _pick=require("../util/object-util")._pick;var TransportFactory=require("../transport/http-transport-factory");var VariablesService=require("./variables-api-service");var IntrospectionService=require("./introspection-api-service");var SessionManager=require("../store/session-manager");module.exports=function(config){var defaults={token:void 0,account:void 0,project:void 0,filter:"",id:"",autoRestore:!0,success:$.noop,error:$.noop,transport:{}};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);serviceOptions.id&&(serviceOptions.filter=serviceOptions.id);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account&&(urlConfig.accountPath=serviceOptions.account),serviceOptions.project&&(urlConfig.projectPath=serviceOptions.project),urlConfig.filter=";",urlConfig.getFilterURL=function(){var url=urlConfig.getAPIPath("run");var filter=qutil.toMatrixFormat(serviceOptions.filter);return filter&&(url+=filter+"/"),url},urlConfig.addAutoRestoreHeader=function(options){var filter=serviceOptions.filter;var isFilterRunId=filter&&"string"===$.type(filter);if(serviceOptions.autoRestore&&isFilterRunId){var autorestoreOpts={headers:{"X-AutoRestore":!0}};return $.extend(!0,autorestoreOpts,options)}return options};var httpOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getFilterURL});serviceOptions.token&&(httpOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(httpOptions);http.splitGet=rutil.splitGetFactory(httpOptions);var setFilterOrThrowError=function(options){if(options.id&&(serviceOptions.filter=options.id),options.filter&&(serviceOptions.filter=options.filter),!serviceOptions.filter)throw new Error("No filter specified to apply operations against")};var publicAsyncAPI={urlConfig:urlConfig,create:function(params,options){var createOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath("run")});var runApiParams=["model","scope","files"];params="string"==typeof params?{model:params}:_pick(params,runApiParams);var oldSuccess=createOptions.success;return createOptions.success=function(response){return serviceOptions.filter=response.id,serviceOptions.id=response.id,oldSuccess.apply(this,arguments)},http.post(params,createOptions)},query:function(qs,outputModifier,options){serviceOptions.filter=qs;var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions=urlConfig.addAutoRestoreHeader(httpOptions),http.splitGet(outputModifier,httpOptions).then(function(r){return $.isPlainObject(r)&&0===Object.keys(r).length?[]:r})},filter:function(filter,outputModifier,options){$.isPlainObject(serviceOptions.filter)?$.extend(serviceOptions.filter,filter):serviceOptions.filter=filter;var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions=urlConfig.addAutoRestoreHeader(httpOptions),http.splitGet(outputModifier,httpOptions).then(function(r){return $.isPlainObject(r)&&0===Object.keys(r).length?[]:r})},load:function(runID,filters,options){runID&&(serviceOptions.filter=runID);var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions=urlConfig.addAutoRestoreHeader(httpOptions),http.get(filters,httpOptions)},save:function(attributes,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return setFilterOrThrowError(httpOptions),http.patch(attributes,httpOptions)},do:function(operation,params,options){var opsArgs;var postOptions;options?(opsArgs=params,postOptions=options):$.isPlainObject(params)?(opsArgs=null,postOptions=params):opsArgs=params;var result=rutil.normalizeOperations(operation,opsArgs);var httpOptions=$.extend(!0,{},serviceOptions,postOptions);setFilterOrThrowError(httpOptions);var prms=result.args[0].length&&null!==result.args[0]&&void 0!==result.args[0]?result.args[0]:[];return http.post({arguments:prms},$.extend(!0,{},httpOptions,{url:urlConfig.getFilterURL()+"operations/"+result.ops[0]+"/"}))},serial:function(operations,params,options){var opParams=rutil.normalizeOperations(operations,params);var ops=opParams.ops;var args=opParams.args;var me=this;var $d=$.Deferred();var postOptions=$.extend(!0,{},serviceOptions,options);var responses=[];var doSingleOp=function(){var op=ops.shift();var arg=args.shift();me.do(op,arg,{success:function(result){responses.push(result),ops.length?doSingleOp():($d.resolve(responses),postOptions.success(responses,me))},error:function(err){responses.push(err),$d.reject(responses),postOptions.error(responses,me)}})};return doSingleOp(),$d.promise()},parallel:function(operations,params,options){var $d=$.Deferred();var opParams=rutil.normalizeOperations(operations,params);var ops=opParams.ops;var args=opParams.args;var postOptions=$.extend(!0,{},serviceOptions,options);var queue=[];for(var i=0;i<ops.length;i++)queue.push(this.do(ops[i],args[i]));var me=this;return $.when.apply(this,queue).then(function(){var args=Array.prototype.slice.call(arguments);var actualResponse=args.map(function(a){return a[0]});$d.resolve(actualResponse),postOptions.success(actualResponse,me)}).fail(function(){var args=Array.prototype.slice.call(arguments);var actualResponse=args.map(function(a){return a[0]});$d.reject(actualResponse),postOptions.error(actualResponse,me)}),$d.promise()},introspect:function(options,introspectionConfig){var introspection=new IntrospectionService($.extend(!0,{},serviceOptions,introspectionConfig));if(!options){if(serviceOptions.id)return introspection.byRunID(serviceOptions.id);throw new Error("Please specify either the model or runid to introspect")}return options.runID?introspection.byRunID(options.runID):options.model?introspection.byModel(options.model):void 0}};var publicSyncAPI={getCurrentConfig:function(){return serviceOptions},updateConfig:function(config){config&&config.id?config.filter=config.id:config&&config.filter&&(config.id=config.filter),serviceOptions=$.extend(!0,{},serviceOptions,config)},variables:function(config){var vs=new VariablesService($.extend(!0,{},serviceOptions,config,{runService:this}));return vs}};$.extend(this,publicAsyncAPI),$.extend(this,publicSyncAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"../util/object-util":49,"../util/query-util":51,"../util/run-util":52,"./configuration-service":31,"./introspection-api-service":34,"./variables-api-service":41}],37:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var SessionManager=require("../store/session-manager");var objectAssign=require("object-assign");var serviceUtils={getDefaultOptions:function(defaults){var rest=Array.prototype.slice.call(arguments,1);var sessionManager=new SessionManager;var serviceOptions=sessionManager.getMergedOptions.apply(sessionManager,[defaults].concat(rest));return serviceOptions.transport=objectAssign({},serviceOptions.transport,{url:this.getApiUrl(serviceOptions.apiEndpoint,serviceOptions)}),serviceOptions.token&&(serviceOptions.transport.headers={Authorization:"Bearer "+serviceOptions.token}),serviceOptions},getApiUrl:function(apiEndpoint,serviceOptions){var urlConfig=new ConfigService(serviceOptions).get("server");return urlConfig.getAPIPath(apiEndpoint)}};module.exports=serviceUtils;
},{"../store/session-manager":44,"./configuration-service":31,"object-assign":2}],38:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var _pick=require("../util/object-util")._pick;var SessionManager=require("../store/session-manager");var apiEndpoint="model/state";module.exports=function(config){var defaults={};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions);var parseRunIdOrError=function(params){if($.isPlainObject(params)&&params.runId)return params.runId;throw new Error("Please pass in a run id")};var publicAPI={load:function(runId,options){var httpParams=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+runId});return http.get("",httpParams)},replay:function(params,options){var runId=parseRunIdOrError(params);var replayOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+runId});return params=$.extend(!0,{action:"replay"},_pick(params,["stopBefore","exclude"])),http.post(params,replayOptions)},clone:function(params,options){var runId=parseRunIdOrError(params);var replayOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+runId});return params=$.extend(!0,{action:"clone"},_pick(params,["stopBefore","exclude"])),http.post(params,replayOptions)}};$.extend(this,publicAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"../util/object-util":49,"./configuration-service":31}],39:[function(require,module,exports){
"use strict";function getLocalHost(existingFn,host){var localHostFn;return localHostFn=void 0!==existingFn?$.isFunction(existingFn)?existingFn:function(){return existingFn}:function(){var isLocal=!host||"127.0.0.1"===host||0===host.indexOf("local.")||0===host.indexOf("localhost");return isLocal}}var epiVersion=require("../api-version.json");var defaults={host:window.location.host,pathname:window.location.pathname};var UrlConfigService=function(config){var envConf=UrlConfigService.defaults;config||(config={});var overrides=$.extend({},envConf,config);var options=$.extend({},defaults,overrides);overrides.isLocalhost=options.isLocalhost=getLocalHost(options.isLocalhost,options.host);var actingHost=config&&config.host;actingHost=!actingHost&&options.isLocalhost()?"forio.com":options.host;var API_PROTOCOL="https";var HOST_API_MAPPING={"forio.com":"api.forio.com","foriodev.com":"api.epicenter.foriodev.com"};var publicExports={protocol:API_PROTOCOL,api:"",host:function(){var apiHost=HOST_API_MAPPING[actingHost]?HOST_API_MAPPING[actingHost]:actingHost;return apiHost}(),isCustomDomain:function(){var path=options.pathname.split("/");var pathHasApp=path&&"app"===path[1];return!options.isLocalhost()&&!pathHasApp}(),appPath:function(){var path=options.pathname.split("/");return path&&path[1]||""}(),accountPath:function(){var accnt="";var path=options.pathname.split("/");return path&&"app"===path[1]&&(accnt=path[2]),accnt}(),projectPath:function(){var prj="";var path=options.pathname.split("/");return path&&"app"===path[1]&&(prj=path[3]),prj}(),versionPath:function(){var version=epiVersion.version?epiVersion.version+"/":"";return version}(),getAPIPath:function(api){var PROJECT_APIS=["run","data","file"];if("config"===api)return this.protocol+"://"+actingHost+"/epicenter/v1/config";var apiPath=this.protocol+"://"+this.host+"/"+this.versionPath+api+"/";return $.inArray(api,PROJECT_APIS)!==-1&&(apiPath+=this.accountPath+"/"+this.projectPath+"/"),apiPath}};return $.extend(publicExports,overrides),publicExports};UrlConfigService.defaults={},module.exports=UrlConfigService;
},{"../api-version.json":3}],40:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var SessionManager=require("../store/session-manager");var qutil=require("../util/query-util");module.exports=function(config){var defaults={account:void 0,token:void 0,transport:{}};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath("user")});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions);var publicAPI={get:function(filter,options){options=options||{},filter=filter||{};var getOptions=$.extend(!0,{},serviceOptions,options);var toQFilter=function(filter){var res={};return filter.userName&&(res.q=filter.userName),res};var toIdFilters=function(id){return id?(id=$.isArray(id)?id:[id],"id="+id.join("&id=")):""};var getFilters=["account="+getOptions.account,toIdFilters(filter.id),qutil.toQueryFormat(toQFilter(filter))].join("&");var threshold=30;return filter.id&&$.isArray(filter.id)&&filter.id.length>=threshold?(getOptions.url=urlConfig.getAPIPath("user")+"?_method=GET",http.post({id:filter.id},getOptions)):http.get(getFilters,getOptions)},getById:function(userId,options){return publicAPI.get({id:userId},options)}};$.extend(this,publicAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"../util/query-util":51,"./configuration-service":31}],41:[function(require,module,exports){
"use strict";var TransportFactory=require("../transport/http-transport-factory");var rutil=require("../util/run-util");module.exports=function(config){var defaults={runService:null};var serviceOptions=$.extend({},defaults,config);var getURL=function(){return serviceOptions.runService.urlConfig.getFilterURL()+"variables/"};var addAutoRestoreHeader=function(options){return serviceOptions.runService.urlConfig.addAutoRestoreHeader(options)};var httpOptions={url:getURL};serviceOptions.token&&(httpOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(httpOptions);http.splitGet=rutil.splitGetFactory(httpOptions);var publicAPI={load:function(variable,outputModifier,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions=addAutoRestoreHeader(httpOptions),http.get(outputModifier,$.extend({},httpOptions,{url:getURL()+variable+"/"}))},query:function(query,outputModifier,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions=addAutoRestoreHeader(httpOptions),$.isArray(query)&&(query={include:query}),$.extend(query,outputModifier),http.splitGet(query,httpOptions)},save:function(variable,val,options){var attrs;"object"==typeof variable?(attrs=variable,options=val):(attrs={})[variable]=val;var httpOptions=$.extend(!0,{},serviceOptions,options);return http.patch.call(this,attrs,httpOptions)}};$.extend(this,publicAPI)};
},{"../transport/http-transport-factory":47,"../util/run-util":52}],42:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var SessionManager=require("../store/session-manager");var _pick=require("../util/object-util")._pick;var apiBase="multiplayer/";var assignmentEndpoint=apiBase+"assign";var apiEndpoint=apiBase+"world";var projectEndpoint=apiBase+"project";module.exports=function(config){var defaults={token:void 0,project:void 0,account:void 0,group:void 0,model:void 0,filter:"",id:"",transport:{},success:$.noop,error:$.noop};this.sessionManager=new SessionManager;var serviceOptions=this.sessionManager.getMergedOptions(defaults,config);serviceOptions.id&&(serviceOptions.filter=serviceOptions.id);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account||(serviceOptions.account=urlConfig.accountPath),serviceOptions.project||(serviceOptions.project=urlConfig.projectPath);var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions);var setIdFilterOrThrowError=function(options){if(options.id&&(serviceOptions.filter=options.id),options.filter&&(serviceOptions.filter=options.filter),!serviceOptions.filter)throw new Error("No world id specified to apply operations against. This could happen if the user is not assigned to a world and is trying to work with runs from that world.")};var validateModelOrThrowError=function(options){if(!options.model)throw new Error("No model specified to get the current run")};var publicAPI={create:function(params,options){var createOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)});var worldApiParams=["scope","files","roles","optionalRoles","minUsers","group","name"];var validParams=_pick(serviceOptions,["account","project","group"]);params=_pick(params,worldApiParams),params=$.extend({},validParams,params);var oldSuccess=createOptions.success;return createOptions.success=function(response){return serviceOptions.filter=response.id,oldSuccess.apply(this,arguments)},http.post(params,createOptions)},update:function(params,options){var whitelist=["roles","optionalRoles","minUsers"];options=options||{},setIdFilterOrThrowError(options);var updateOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter});return params=_pick(params||{},whitelist),http.patch(params,updateOptions)},delete:function(options){options=options&&"string"==typeof options?{filter:options}:{},setIdFilterOrThrowError(options);var deleteOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter});return http.delete(null,deleteOptions)},updateConfig:function(config){return $.extend(serviceOptions,config),this},list:function(options){options=options||{};var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)});var filters=_pick(getOptions,["account","project","group"]);return http.get(filters,getOptions)},getWorldsForUser:function(userId,options){options=options||{};var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)});var filters=$.extend(_pick(getOptions,["account","project","group"]),{userId:userId});return http.get(filters,getOptions)},load:function(worldId,options){if(worldId&&(serviceOptions.filter=worldId),!serviceOptions.filter)throw new Error("Please provide a worldid to load");var httpOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/"});return http.get("",httpOptions)},addUsers:function(users,worldId,options){if(!users)throw new Error("Please provide a list of users to add to the world");users=$.map([].concat(users),function(u){var isObject=$.isPlainObject(u);if("string"!=typeof u&&!isObject)throw new Error("Some of the users in the list are not in the valid format: "+u);return isObject?u:{userId:u}}),$.isPlainObject(worldId)&&!options&&(options=worldId,worldId=null),options=options||{},"string"==typeof worldId&&(options.filter=worldId),setIdFilterOrThrowError(options);var updateOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/users"});return http.post(users,updateOptions)},updateUser:function(user,options){if(options=options||{},!user||!user.userId)throw new Error("You need to pass a userId to update from the world");setIdFilterOrThrowError(options);var patchOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/users/"+user.userId});return http.patch(_pick(user,"role"),patchOptions)},removeUser:function(user,options){if(options=options||{},"string"==typeof user&&(user={userId:user}),!user.userId)throw new Error("You need to pass a userId to remove from the world");setIdFilterOrThrowError(options);var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/users/"+user.userId});return http.delete(null,getOptions)},getCurrentRunId:function(options){options=options||{},setIdFilterOrThrowError(options);var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/run"});return validateModelOrThrowError(getOptions),http.post(_pick(getOptions,"model"),getOptions)},getCurrentWorldForUser:function(userId,groupName){var dtd=$.Deferred();var me=this;return this.getWorldsForUser(userId,{group:groupName}).then(function(worlds){worlds.sort(function(a,b){return new Date(b.lastModified)-new Date(a.lastModified)});var currentWorld=worlds[0];currentWorld&&(serviceOptions.filter=currentWorld.id),dtd.resolveWith(me,[currentWorld])}).fail(dtd.reject),dtd.promise()},deleteRun:function(worldId,options){options=options||{},worldId&&(options.filter=worldId),setIdFilterOrThrowError(options);var deleteOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/run"});return http.delete(null,deleteOptions)},newRunForWorld:function(worldId,options){var currentRunOptions=$.extend(!0,{},options,{filter:worldId||serviceOptions.filter});var me=this;return validateModelOrThrowError(currentRunOptions),this.deleteRun(worldId,options).then(function(){return me.getCurrentRunId(currentRunOptions)})},autoAssign:function(options){options=options||{};var opt=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(assignmentEndpoint)});var params={account:opt.account,project:opt.project,group:opt.group};return opt.maxUsers&&(params.maxUsers=opt.maxUsers),http.post(params,opt)},getProjectSettings:function(options){options=options||{};var opt=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(projectEndpoint)});return opt.url+=[opt.account,opt.project].join("/"),http.get(null,opt)}};$.extend(this,publicAPI)};
},{"../store/session-manager":44,"../transport/http-transport-factory":47,"../util/object-util":49,"./configuration-service":31}],43:[function(require,module,exports){
"use strict";var Cookie=function(){this.get=function(){return document.cookie},this.set=function(newCookie){document.cookie=newCookie}};module.exports=function(config){var host=window.location.hostname;var validHost=host.split(".").length>1;var domain=validHost?"."+host:null;var defaults={root:"/",domain:domain,cookie:new Cookie};this.serviceOptions=$.extend({},defaults,config);var publicAPI={set:function(key,value,options){var setOptions=$.extend(!0,{},this.serviceOptions,options);var domain=setOptions.domain;var path=setOptions.root;var cookie=setOptions.cookie;return cookie.set(encodeURIComponent(key)+"="+encodeURIComponent(value)+(domain?"; domain="+domain:"")+(path?"; path="+path:"")),value},get:function(key){var cookie=this.serviceOptions.cookie;var cookieReg=new RegExp("(?:^|;)\\s*"+encodeURIComponent(key).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$");var res=cookieReg.exec(cookie.get());var val=res?decodeURIComponent(res[1]):null;return val},remove:function(key,options){var remOptions=$.extend(!0,{},this.serviceOptions,options);var domain=remOptions.domain;var path=remOptions.root;var cookie=remOptions.cookie;return cookie.set(encodeURIComponent(key)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(domain?"; domain="+domain:"")+(path?"; path="+path:"")),key},destroy:function(){var cookie=this.serviceOptions.cookie;var aKeys=cookie.get().replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/);for(var nIdx=0;nIdx<aKeys.length;nIdx++){var cookieKey=decodeURIComponent(aKeys[nIdx]);this.remove(cookieKey)}return aKeys}};$.extend(this,publicAPI)};
},{}],44:[function(require,module,exports){
"use strict";var keyNames=require("../managers/key-names");var StorageFactory=require("./store-factory");var optionUtils=require("../util/option-utils");var EPI_SESSION_KEY=keyNames.EPI_SESSION_KEY;var defaults={store:{synchronous:!0}};var SessionManager=function(managerOptions){function getBaseOptions(overrides){overrides=overrides||{};var libOptions=optionUtils.getOptions();var finalOptions=$.extend(!0,{},defaults,libOptions,managerOptions,overrides);return finalOptions}function getStore(overrides){var baseOptions=getBaseOptions(overrides);var storeOpts=baseOptions.store||{};var isEpicenterDomain=!baseOptions.isLocal&&!baseOptions.isCustomDomain;return void 0===storeOpts.root&&baseOptions.account&&baseOptions.project&&isEpicenterDomain&&(storeOpts.root="/app/"+baseOptions.account+"/"+baseOptions.project),new StorageFactory(storeOpts)}managerOptions=managerOptions||{};var publicAPI={saveSession:function(userInfo,options){var serialized=JSON.stringify(userInfo);getStore(options).set(EPI_SESSION_KEY,serialized)},getSession:function(options){var store=getStore(options);var finalOpts=store.serviceOptions;var serialized=store.get(EPI_SESSION_KEY)||"{}";var session=JSON.parse(serialized);var account=finalOpts.account;var project=finalOpts.project;if(account&&session.account!==account)return{};if(session.groups&&account&&project){var group=session.groups[project]||{groupId:"",groupName:"",isFac:!1};$.extend(session,{project:project},group)}return session},removeSession:function(options){var store=getStore(options);return Object.keys(keyNames).forEach(function(cookieKey){var cookieName=keyNames[cookieKey];store.remove(cookieName)}),!0},getStore:function(options){return getStore(options)},getMergedOptions:function(){var args=Array.prototype.slice.call(arguments);var overrides=$.extend.apply($,[!0,{}].concat(args));var baseOptions=getBaseOptions(overrides);var session=this.getSession(overrides);var sessionDefaults={token:session.auth_token,account:session.account,project:session.project,group:session.groupName,groupName:session.groupName,groupId:session.groupId,userId:session.userId};return $.extend(!0,sessionDefaults,baseOptions)}};$.extend(this,publicAPI)};module.exports=SessionManager;
},{"../managers/key-names":9,"../util/option-utils":50,"./store-factory":45}],45:[function(require,module,exports){
"use strict";var store=require("./cookie-store");module.exports=store;
},{"./cookie-store":43}],46:[function(require,module,exports){
"use strict";var qutils=require("../util/query-util");module.exports=function(config){var defaults={url:"",contentType:"application/json",headers:{},statusCode:{404:$.noop},parameterParser:qutils.toQueryFormat,xhrFields:{withCredentials:!0}};var transportOptions=$.extend({},defaults,config);var result=function(d){return $.isFunction(d)?d():d};var connect=function(method,params,connectOptions){params=result(params),params=$.isPlainObject(params)||$.isArray(params)?JSON.stringify(params):params;var options=$.extend(!0,{},transportOptions,connectOptions,{type:method,data:params});var ALLOWED_TO_BE_FUNCTIONS=["data","url"];if($.each(options,function(key,value){$.isFunction(value)&&$.inArray(key,ALLOWED_TO_BE_FUNCTIONS)!==-1&&(options[key]=value())}),options.logLevel&&"DEBUG"===options.logLevel){console.log(options.url);var oldSuccessFn=options.success||$.noop;options.success=function(response,ajaxStatus,ajaxReq){console.log(response),oldSuccessFn.apply(this,arguments)}}var beforeSend=options.beforeSend;return options.beforeSend=function(xhr,settings){xhr.requestUrl=(connectOptions||{}).url,beforeSend&&beforeSend.apply(this,arguments)},$.ajax(options)};var publicAPI={get:function(params,ajaxOptions){var options=$.extend({},transportOptions,ajaxOptions);return params=options.parameterParser(result(params)),connect.call(this,"GET",params,options)},splitGet:function(){},post:function(){return connect.apply(this,["post"].concat([].slice.call(arguments)))},patch:function(){return connect.apply(this,["patch"].concat([].slice.call(arguments)))},put:function(){return connect.apply(this,["put"].concat([].slice.call(arguments)))},delete:function(params,ajaxOptions){var options=$.extend({},transportOptions,ajaxOptions);if(params=options.parameterParser(result(params)),$.trim(params)){var delimiter=result(options.url).indexOf("?")===-1?"?":"&";options.url=result(options.url)+delimiter+params}return connect.call(this,"DELETE",null,options)},head:function(){return connect.apply(this,["head"].concat([].slice.call(arguments)))},options:function(){return connect.apply(this,["options"].concat([].slice.call(arguments)))}};return $.extend(this,publicAPI)};
},{"../util/query-util":51}],47:[function(require,module,exports){
"use strict";var transport=require("./ajax-http-transport");module.exports=transport;
},{"./ajax-http-transport":46}],48:[function(require,module,exports){
"use strict";function inherit(C,P){var F=function(){};F.prototype=P.prototype,C.prototype=new F,C.__super=P.prototype,C.prototype.constructor=C}var extend=function(dest){var obj=Array.prototype.slice.call(arguments,1);var current;for(var j=0;j<obj.length;j++)if(current=obj[j])for(var key in current)dest[key]=current[key];return dest};module.exports=function(base,props,staticProps){var parent=base;var child;return child=props&&props.hasOwnProperty("constructor")?props.constructor:function(){return parent.apply(this,arguments)},extend(child,parent,staticProps),inherit(child,parent),props&&extend(child.prototype,props),child};
},{}],49:[function(require,module,exports){
"use strict";module.exports={_pick:function(obj,props){var res={};for(var p in obj)props.indexOf(p)!==-1&&(res[p]=obj[p]);return res},isEmpty:function(value){return!value||$.isPlainObject(value)&&0===Object.keys(value).length}};
},{}],50:[function(require,module,exports){
"use strict";var ConfigService=require("../service/configuration-service");var urlConfig=(new ConfigService).get("server");var customDefaults={};var libDefaults={account:urlConfig.accountPath||void 0,project:urlConfig.projectPath||void 0,isLocal:urlConfig.isLocalhost(),isCustomDomain:urlConfig.isCustomDomain,store:{}};var optionUtils={getOptions:function(options){return $.extend(!0,{},libDefaults,customDefaults,options)},setDefaults:function(defaults){customDefaults=defaults}};module.exports=optionUtils;
},{"../service/configuration-service":31}],51:[function(require,module,exports){
"use strict";module.exports=function(){return{toMatrixFormat:function(qs){if(null===qs||void 0===qs||""===qs)return";";if("string"==typeof qs||qs instanceof String)return qs;var returnArray=[];var OPERATORS=["<",">","!"];$.each(qs,function(key,value){"string"==typeof value&&$.inArray($.trim(value).charAt(0),OPERATORS)!==-1||(value="="+value),returnArray.push(key+value)});var mtrx=";"+returnArray.join(";");return mtrx},toQueryFormat:function(qs){if(null===qs||void 0===qs)return"";if("string"==typeof qs||qs instanceof String)return qs;var returnArray=[];$.each(qs,function(key,value){$.isArray(value)&&(value=value.join(",")),$.isPlainObject(value)&&(value=JSON.stringify(value)),returnArray.push(key+"="+value)});var result=returnArray.join("&");return result},qsToObject:function(qs){if(null===qs||void 0===qs||""===qs)return{};var qsArray=qs.split("&");var returnObj={};return $.each(qsArray,function(index,value){var qKey=value.split("=")[0];var qVal=value.split("=")[1];qVal.indexOf(",")!==-1&&(qVal=qVal.split(",")),returnObj[qKey]=qVal}),returnObj},mergeQS:function(qs1,qs2){var obj1=this.qsToObject(this.toQueryFormat(qs1));var obj2=this.qsToObject(this.toQueryFormat(qs2));return $.extend(!0,{},obj1,obj2)},addTrailingSlash:function(url){return url?"/"===url.charAt(url.length-1)?url:url+"/":""}}}();
},{}],52:[function(require,module,exports){
"use strict";var qutil=require("./query-util");var MAX_URL_LENGTH=2048;module.exports=function(){return{normalizeOperations:function(operations,args){args||(args=[]);var returnList={ops:[],args:[]};var _concat=function(arr){return null!==arr&&void 0!==arr?[].concat(arr):[]};var _normalizePlainObjects=function(operations,returnList){return returnList||(returnList={ops:[],args:[]}),$.each(operations,function(opn,arg){returnList.ops.push(opn),returnList.args.push(_concat(arg))}),returnList};var _normalizeStructuredObjects=function(operation,returnList){return returnList||(returnList={ops:[],args:[]}),returnList.ops.push(operation.name),returnList.args.push(_concat(operation.params)),returnList};var _normalizeObject=function(operation,returnList){return(operation.name?_normalizeStructuredObjects:_normalizePlainObjects)(operation,returnList)};var _normalizeLiterals=function(operation,args,returnList){return returnList||(returnList={ops:[],args:[]}),returnList.ops.push(operation),returnList.args.push(_concat(args)),returnList};var _normalizeArrays=function(operations,arg,returnList){return returnList||(returnList={ops:[],args:[]}),$.each(operations,function(index,opn){$.isPlainObject(opn)?_normalizeObject(opn,returnList):_normalizeLiterals(opn,args[index],returnList)}),returnList};return $.isPlainObject(operations)?_normalizeObject(operations,returnList):$.isArray(operations)?_normalizeArrays(operations,args,returnList):_normalizeLiterals(operations,args,returnList),returnList},splitGetFactory:function(httpOptions){return function(params,options){var http=this;var getValue=function(name){var value=options[name]||httpOptions[name];return"function"==typeof value&&(value=value()),value};var getFinalUrl=function(params){var url=getValue("url",options);var data=params;url=url.replace(/#.*$/,"");var queryParams=qutil.toQueryFormat(data);var questionIdx=url.indexOf("?");return queryParams&&questionIdx>-1?url+"&"+queryParams:queryParams?url+"?"+queryParams:url};var url=getFinalUrl(params);if(params&&params.include&&encodeURI(url).length>MAX_URL_LENGTH){var dtd=$.Deferred();var paramsCopy=$.extend(!0,{},params);delete paramsCopy.include;var urlNoIncludes=getFinalUrl(paramsCopy);var diff=MAX_URL_LENGTH-urlNoIncludes.length;var oldSuccess=options.success||httpOptions.success||$.noop;var oldError=options.error||httpOptions.error||$.noop;options.success=$.noop,options.error=$.noop;var include=params.include;var currIncludes=[];var includeOpts=[currIncludes];var currLength=encodeURIComponent("?include=").length;var variable=include.pop();for(;variable;){var varLenght=encodeURIComponent(variable).length;currLength+varLenght+1<diff?(currIncludes.push(variable),currLength+=varLenght+1):(currIncludes=[variable],includeOpts.push(currIncludes),currLength="?include=".length+varLenght),variable=include.pop()}var reqs=$.map(includeOpts,function(include){var reqParams=$.extend({},params,{include:include});return http.get(reqParams,options)});return $.when.apply($,reqs).then(function(){var isValid=arguments[0]&&arguments[0][0];if(!isValid)return oldError(),dtd.reject();var firstResponse=arguments[0][0];var isObject=$.isPlainObject(firstResponse);var isRunAPI=isObject&&$.isPlainObject(firstResponse.variables)||!isObject;if(isRunAPI)if(isObject){var aggregateRun=arguments[0][0];$.each(arguments,function(idx,args){var run=args[0];$.extend(!0,aggregateRun.variables,run.variables)}),oldSuccess(aggregateRun,arguments[0][1],arguments[0][2]),dtd.resolve(aggregateRun,arguments[0][1],arguments[0][2])}else{var aggregatedRuns={};$.each(arguments,function(idx,args){var runs=args[0];$.isArray(runs)&&$.each(runs,function(idxRun,run){run.id&&!aggregatedRuns[run.id]?(run.variables=run.variables||{},aggregatedRuns[run.id]=run):run.id&&$.extend(!0,aggregatedRuns[run.id].variables,run.variables)})}),aggregatedRuns=$.map(aggregatedRuns,function(run){return run}),oldSuccess(aggregatedRuns,arguments[0][1],arguments[0][2]),dtd.resolve(aggregatedRuns,arguments[0][1],arguments[0][2])}else{var aggregatedVariables={};$.each(arguments,function(idx,args){var vars=args[0];$.extend(!0,aggregatedVariables,vars)}),oldSuccess(aggregatedVariables,arguments[0][1],arguments[0][2]),dtd.resolve(aggregatedVariables,arguments[0][1],arguments[0][2])}},function(){oldError.apply(http,arguments),dtd.reject.apply(dtd,arguments)}),dtd.promise()}return http.get(params,options)}}}}();
},{"./query-util":51}]},{},[4])


//# sourceMappingURL=epicenter.min.js.map