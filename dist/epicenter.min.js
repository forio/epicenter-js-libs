(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var type=typeof subject;var length;if("number"===type)length=+subject;else if("string"===type)length=Buffer.byteLength(subject,encoding);else{if("object"!==type||null===subject)throw new TypeError("must start with number, buffer, array or string");"Buffer"===subject.type&&isArray(subject.data)&&(subject=subject.data),length=+subject.length}if(length>kMaxLength)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength.toString(16)+" bytes");0>length?length=0:length>>>=0;var self=this;Buffer.TYPED_ARRAY_SUPPORT?self=Buffer._augment(new Uint8Array(length)):(self.length=length,self._isBuffer=!0);var i;if(Buffer.TYPED_ARRAY_SUPPORT&&"number"==typeof subject.byteLength)self._set(subject);else if(isArrayish(subject))if(Buffer.isBuffer(subject))for(i=0;length>i;i++)self[i]=subject.readUInt8(i);else for(i=0;length>i;i++)self[i]=(subject[i]%256+256)%256;else if("string"===type)self.write(subject,0,encoding);else if("number"===type&&!Buffer.TYPED_ARRAY_SUPPORT&&!noZero)for(i=0;length>i;i++)self[i]=0;return length>0&&length<=Buffer.poolSize&&(self.parent=rootParent),self}function SlowBuffer(subject,encoding,noZero){if(!(this instanceof SlowBuffer))return new SlowBuffer(subject,encoding,noZero);var buf=new Buffer(subject,encoding,noZero);return delete buf.parent,buf}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;if(strLen%2!==0)throw new Error("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;length>i;i++){var byte=parseInt(string.substr(2*i,2),16);if(isNaN(byte))throw new Error("Invalid hex string");buf[offset+i]=byte}return i}function utf8Write(buf,string,offset,length){var charsWritten=blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length);return charsWritten}function asciiWrite(buf,string,offset,length){var charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length);return charsWritten}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){var charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length);return charsWritten}function utf16leWrite(buf,string,offset,length){var charsWritten=blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length,2);return charsWritten}function base64Slice(buf,start,end){return base64.fromByteArray(0===start&&end===buf.length?buf:buf.slice(start,end))}function utf8Slice(buf,start,end){var res="";var tmp="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)buf[i]<=127?(res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]),tmp=""):tmp+="%"+buf[i].toString(16);return res+decodeUtf8Char(tmp)}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(127&buf[i]);return ret}function binarySlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||0>start)&&(start=0),(!end||0>end||end>len)&&(end=len);var out="";for(var i=start;end>i;i++)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res="";for(var i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||0>offset)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError("buffer must be a Buffer instance");if(value>max||min>value)throw new RangeError("value is out of bounds");if(offset+ext>buf.length)throw new RangeError("index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){0>value&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);j>i;i++)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){0>value&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);j>i;i++)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(value>max||min>value)throw new RangeError("value is out of bounds");if(offset+ext>buf.length)throw new RangeError("index out of range");if(0>offset)throw new RangeError("index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){if(str=stringtrim(str).replace(INVALID_BASE64_RE,""),str.length<2)return"";for(;str.length%4!==0;)str+="=";return str}function stringtrim(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&"object"==typeof subject&&"number"==typeof subject.length}function toHex(n){return 16>n?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){units=units||1/0;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];var i=0;for(;length>i;i++){if(codePoint=string.charCodeAt(i),codePoint>55295&&57344>codePoint){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(56320>codePoint){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=leadSurrogate-55296<<10|codePoint-56320|65536,leadSurrogate=null}else leadSurrogate&&((units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=null);if(128>codePoint){if((units-=1)<0)break;bytes.push(codePoint)}else if(2048>codePoint){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(65536>codePoint){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(2097152>codePoint))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length&&!((units-=2)<0);i++)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length,unitSize){unitSize&&(length-=length%unitSize);for(var i=0;length>i&&!(i+offset>=dst.length||i>=src.length);i++)dst[i+offset]=src[i];return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}var base64=require("base64-js");var ieee754=require("ieee754");var isArray=require("is-array");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var kMaxLength=1073741823;var rootParent={};Buffer.TYPED_ARRAY_SUPPORT=function(){try{var buf=new ArrayBuffer(0);var arr=new Uint8Array(buf);return arr.foo=function(){return 42},42===arr.foo()&&"function"==typeof arr.subarray&&0===new Uint8Array(1).subarray(1,1).byteLength}catch(e){return!1}}(),Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);len>i&&a[i]===b[i];i++);return i!==len&&(x=a[i],y=b[i]),y>x?-1:x>y?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,totalLength){if(!isArray(list))throw new TypeError("Usage: Buffer.concat(list[, length])");if(0===list.length)return new Buffer(0);if(1===list.length)return list[0];var i;if(void 0===totalLength)for(totalLength=0,i=0;i<list.length;i++)totalLength+=list[i].length;var buf=new Buffer(totalLength);var pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos),pos+=item.length}return buf},Buffer.byteLength=function(str,encoding){var ret;switch(str+="",encoding||"utf8"){case"ascii":case"binary":case"raw":ret=str.length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=2*str.length;break;case"hex":ret=str.length>>>1;break;case"utf8":case"utf-8":ret=utf8ToBytes(str).length;break;case"base64":ret=base64ToBytes(str).length;break;default:ret=str.length}return ret},Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0,Buffer.prototype.toString=function(encoding,start,end){var loweredCase=!1;if(start>>>=0,end=void 0===end||1/0===end?this.length:end>>>0,encoding||(encoding="utf8"),0>start&&(start=0),end>this.length&&(end=this.length),start>=end)return"";for(;;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"binary":return binarySlice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b?!0:0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="";var max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b?0:Buffer.compare(this,b)},Buffer.prototype.get=function(offset){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(offset)},Buffer.prototype.set=function(v,offset){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(v,offset)},Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset))isFinite(length)||(encoding=length,length=void 0);else{var swap=encoding;encoding=offset,offset=length,length=swap}if(offset=Number(offset)||0,0>length||0>offset||offset>this.length)throw new RangeError("attempt to write outside buffer bounds");var remaining=this.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining,encoding=String(encoding||"utf8").toLowerCase();var ret;switch(encoding){case"hex":ret=hexWrite(this,string,offset,length);break;case"utf8":case"utf-8":ret=utf8Write(this,string,offset,length);break;case"ascii":ret=asciiWrite(this,string,offset,length);break;case"binary":ret=binaryWrite(this,string,offset,length);break;case"base64":ret=base64Write(this,string,offset,length);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=utf16leWrite(this,string,offset,length);break;default:throw new TypeError("Unknown encoding: "+encoding)}return ret},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},Buffer.prototype.slice=function(start,end){var len=this.length;start=~~start,end=void 0===end?len:~~end,0>start?(start+=len,0>start&&(start=0)):start>len&&(start=len),0>end?(end+=len,0>end&&(end=0)):end>len&&(end=len),start>end&&(end=start);var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT)newBuf=Buffer._augment(this.subarray(start,end));else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,void 0,!0);for(var i=0;sliceLen>i;i++)newBuf[i]=this[i+start]}return newBuf.length&&(newBuf.parent=this.parent||this),newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;for(;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);var val=this[offset+--byteLength];var mul=1;for(;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;for(;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];for(;i>0&&(mul*=256);)val+=this[offset+--i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,byteLength>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var mul=1;var i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul>>>0&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,byteLength>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var i=byteLength-1;var mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul>>>0&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength-1)-1,-Math.pow(2,8*byteLength-1));var i=0;var mul=1;var sub=0>value?1:0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength-1)-1,-Math.pow(2,8*byteLength-1));var i=byteLength-1;var mul=1;var sub=0>value?1:0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),0>value&&(value=255+value+1),this[offset]=value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),0>value&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,target_start,start,end){var self=this;if(start||(start=0),end||0===end||(end=this.length),target_start>=target.length&&(target_start=target.length),target_start||(target_start=0),end>0&&start>end&&(end=start),end===start)return 0;if(0===target.length||0===self.length)return 0;if(0>target_start)throw new RangeError("targetStart out of bounds");if(0>start||start>=self.length)throw new RangeError("sourceStart out of bounds");if(0>end)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-target_start<end-start&&(end=target.length-target_start+start);var len=end-start;if(1e3>len||!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;len>i;i++)target[i+target_start]=this[i+start];else target._set(this.subarray(start,start+len),target_start);return len},Buffer.prototype.fill=function(value,start,end){if(value||(value=0),start||(start=0),end||(end=this.length),start>end)throw new RangeError("end < start");if(end!==start&&0!==this.length){if(0>start||start>=this.length)throw new RangeError("start out of bounds");if(0>end||end>this.length)throw new RangeError("end out of bounds");var i;if("number"==typeof value)for(i=start;end>i;i++)this[i]=value;else{var bytes=utf8ToBytes(value.toString());var len=bytes.length;for(i=start;end>i;i++)this[i]=bytes[i%len]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;var buf=new Uint8Array(this.length);for(var i=0,len=buf.length;len>i;i+=1)buf[i]=this[i];return buf.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(arr){return arr.constructor=Buffer,arr._isBuffer=!0,arr._get=arr.get,arr._set=arr.set,arr.get=BP.get,arr.set=BP.set,arr.write=BP.write,arr.toString=BP.toString,arr.toLocaleString=BP.toString,arr.toJSON=BP.toJSON,arr.equals=BP.equals,arr.compare=BP.compare,arr.copy=BP.copy,arr.slice=BP.slice,arr.readUIntLE=BP.readUIntLE,arr.readUIntBE=BP.readUIntBE,arr.readUInt8=BP.readUInt8,arr.readUInt16LE=BP.readUInt16LE,arr.readUInt16BE=BP.readUInt16BE,arr.readUInt32LE=BP.readUInt32LE,arr.readUInt32BE=BP.readUInt32BE,arr.readIntLE=BP.readIntLE,arr.readIntBE=BP.readIntBE,arr.readInt8=BP.readInt8,arr.readInt16LE=BP.readInt16LE,arr.readInt16BE=BP.readInt16BE,arr.readInt32LE=BP.readInt32LE,arr.readInt32BE=BP.readInt32BE,arr.readFloatLE=BP.readFloatLE,arr.readFloatBE=BP.readFloatBE,arr.readDoubleLE=BP.readDoubleLE,arr.readDoubleBE=BP.readDoubleBE,arr.writeUInt8=BP.writeUInt8,arr.writeUIntLE=BP.writeUIntLE,arr.writeUIntBE=BP.writeUIntBE,arr.writeUInt16LE=BP.writeUInt16LE,arr.writeUInt16BE=BP.writeUInt16BE,arr.writeUInt32LE=BP.writeUInt32LE,arr.writeUInt32BE=BP.writeUInt32BE,arr.writeIntLE=BP.writeIntLE,arr.writeIntBE=BP.writeIntBE,arr.writeInt8=BP.writeInt8,arr.writeInt16LE=BP.writeInt16LE,arr.writeInt16BE=BP.writeInt16BE,arr.writeInt32LE=BP.writeInt32LE,arr.writeInt32BE=BP.writeInt32BE,arr.writeFloatLE=BP.writeFloatLE,arr.writeFloatBE=BP.writeFloatBE,arr.writeDoubleLE=BP.writeDoubleLE,arr.writeDoubleBE=BP.writeDoubleBE,arr.fill=BP.fill,arr.inspect=BP.inspect,arr.toArrayBuffer=BP.toArrayBuffer,arr};var INVALID_BASE64_RE=/[^+\/0-9A-z\-]/g;
},{"base64-js":2,"ieee754":3,"is-array":4}],2:[function(require,module,exports){
var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(exports){"use strict";function decode(elt){var code=elt.charCodeAt(0);return code===PLUS||code===PLUS_URL_SAFE?62:code===SLASH||code===SLASH_URL_SAFE?63:NUMBER>code?-1:NUMBER+10>code?code-NUMBER+26+26:UPPER+26>code?code-UPPER:LOWER+26>code?code-LOWER+26:void 0}function b64ToByteArray(b64){function push(v){arr[L++]=v}var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0,arr=new Arr(3*b64.length/4-placeHolders),l=placeHolders>0?b64.length-4:b64.length;var L=0;for(i=0,j=0;l>i;i+=4,j+=3)tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3)),push((16711680&tmp)>>16),push((65280&tmp)>>8),push(255&tmp);return 2===placeHolders?(tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4,push(255&tmp)):1===placeHolders&&(tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2,push(tmp>>8&255),push(255&tmp)),arr}function uint8ToBase64(uint8){function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(63&num)}var i,temp,length,extraBytes=uint8.length%3,output="";for(i=0,length=uint8.length-extraBytes;length>i;i+=3)temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2],output+=tripletToBase64(temp);switch(extraBytes){case 1:temp=uint8[uint8.length-1],output+=encode(temp>>2),output+=encode(temp<<4&63),output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1],output+=encode(temp>>10),output+=encode(temp>>4&63),output+=encode(temp<<2&63),output+="="}return output}var Arr="undefined"!=typeof Uint8Array?Uint8Array:Array;var PLUS="+".charCodeAt(0);var SLASH="/".charCodeAt(0);var NUMBER="0".charCodeAt(0);var LOWER="a".charCodeAt(0);var UPPER="A".charCodeAt(0);var PLUS_URL_SAFE="-".charCodeAt(0);var SLASH_URL_SAFE="_".charCodeAt(0);exports.toByteArray=b64ToByteArray,exports.fromByteArray=uint8ToBase64}("undefined"==typeof exports?this.base64js={}:exports);
},{}],3:[function(require,module,exports){
exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?0/0:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=0>value||0===value&&0>1/value?1:0;for(value=Math.abs(value),isNaN(value)||1/0===value?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s};
},{}],4:[function(require,module,exports){
var isArray=Array.isArray;var str=Object.prototype.toString;module.exports=isArray||function(val){return!!val&&"[object Array]"==str.call(val)};
},{}],5:[function(require,module,exports){
var F={util:{},factory:{},transport:{},store:{},service:{},manager:{strategy:{}}};F.util.query=require("./util/query-util"),F.util.makeSequence=require("./util/make-sequence"),F.util.run=require("./util/run-util"),F.util.classFrom=require("./util/inherit"),F.factory.Transport=require("./transport/http-transport-factory"),F.transport.Ajax=require("./transport/ajax-http-transport"),F.service.URL=require("./service/url-config-service"),F.service.Config=require("./service/configuration-service"),F.service.Run=require("./service/run-api-service"),F.service.Variables=require("./service/variables-api-service"),F.service.Data=require("./service/data-api-service"),F.service.Auth=require("./service/auth-api-service"),F.service.World=require("./service/world-api-adapter"),F.service.State=require("./service/state-api-adapter"),F.service.Member=require("./service/member-api-adapter"),F.store.Cookie=require("./store/cookie-store"),F.factory.Store=require("./store/store-factory"),F.manager.ScenarioManager=require("./managers/scenario-manager"),F.manager.RunManager=require("./managers/run-manager"),F.manager.AuthManager=require("./managers/auth-manager"),F.manager.WorldManager=require("./managers/world-manager"),F.manager.strategy["always-new"]=require("./managers/run-strategies/always-new-strategy"),F.manager.strategy["conditional-creation"]=require("./managers/run-strategies/conditional-creation-strategy"),F.manager.strategy.identity=require("./managers/run-strategies/identity-strategy"),F.manager.strategy["new-if-missing"]=require("./managers/run-strategies/new-if-missing-strategy"),F.manager.strategy["new-if-missing"]=require("./managers/run-strategies/new-if-missing-strategy"),F.manager.strategy["new-if-persisted"]=require("./managers/run-strategies/new-if-persisted-strategy"),F.manager.strategy["new-if-initialized"]=require("./managers/run-strategies/new-if-initialized-strategy"),F.manager.ChannelManager=require("./managers/epicenter-channel-manager"),F.service.Channel=require("./service/channel-service"),F.version="1.4.0",window.F=F;
},{"./managers/auth-manager":6,"./managers/epicenter-channel-manager":8,"./managers/run-manager":10,"./managers/run-strategies/always-new-strategy":11,"./managers/run-strategies/conditional-creation-strategy":12,"./managers/run-strategies/identity-strategy":13,"./managers/run-strategies/new-if-initialized-strategy":15,"./managers/run-strategies/new-if-missing-strategy":16,"./managers/run-strategies/new-if-persisted-strategy":17,"./managers/scenario-manager":20,"./managers/world-manager":22,"./service/auth-api-service":23,"./service/channel-service":24,"./service/configuration-service":25,"./service/data-api-service":26,"./service/member-api-adapter":27,"./service/run-api-service":28,"./service/state-api-adapter":29,"./service/url-config-service":30,"./service/variables-api-service":31,"./service/world-api-adapter":32,"./store/cookie-store":33,"./store/store-factory":34,"./transport/ajax-http-transport":35,"./transport/http-transport-factory":36,"./util/inherit":37,"./util/make-sequence":38,"./util/query-util":40,"./util/run-util":41}],6:[function(require,module,exports){
"use strict";function saveSession(userInfo){var serialized=JSON.stringify(userInfo);store.set(EPI_SESSION_KEY,serialized),store.set(EPI_COOKIE_KEY,userInfo.auth_token)}function getSession(){var session=store.get(EPI_SESSION_KEY)||"{}";return JSON.parse(session)}function AuthManager(options){this.options=$.extend(!0,{},defaults,options);var urlConfig=new ConfigService(this.options).get("server");this.options.account||(this.options.account=urlConfig.accountPath),void 0===this.options.project&&(this.options.project=urlConfig.projectPath),store=new StorageFactory(this.options.store),session=getSession(),token=store.get(EPI_COOKIE_KEY)||"",this.authAdapter=new AuthAdapter(this.options,{token:session.auth_token})}var ConfigService=require("../service/configuration-service");var AuthAdapter=require("../service/auth-api-service");var MemberAdapter=require("../service/member-api-adapter");var StorageFactory=require("../store/store-factory");var Buffer=require("buffer").Buffer;var keyNames=require("./key-names");var defaults={store:{synchronous:!0}};var EPI_COOKIE_KEY=keyNames.EPI_COOKIE_KEY;var EPI_SESSION_KEY=keyNames.EPI_SESSION_KEY;var store;var token;var session;var _findUserInGroup=function(members,id){for(var j=0;j<members.length;j++)if(members[j].userId===id)return members[j];return null};AuthManager.prototype=$.extend(AuthManager.prototype,{login:function(options){var _this=this;var $d=$.Deferred();var adapterOptions=$.extend(!0,{success:$.noop,error:$.noop},this.options,options);var outSuccess=adapterOptions.success;var outError=adapterOptions.error;var groupId=adapterOptions.groupId;var decodeToken=function(token){var encoded=token.split(".")[1];for(;encoded.length%4!==0;)encoded+="=";var decode=window.atob?window.atob:function(encoded){return new Buffer(encoded,"base64").toString("ascii")};return JSON.parse(decode(encoded))};var handleGroupError=function(message,statusCode,data){_this.logout().then(function(){var error=$.extend(!0,{},data,{statusText:message,status:statusCode});$d.reject(error)})};var handleSuccess=function(response){token=response.access_token;var userInfo=decodeToken(token);var userGroupOpts=$.extend(!0,{},adapterOptions,{success:$.noop,token:token});_this.getUserGroups({userId:userInfo.user_id,token:token},userGroupOpts).done(function(memberInfo){var data={auth:response,user:userInfo,userGroups:memberInfo,groupSelection:{}};var sessionInfo={auth_token:token,account:adapterOptions.account,project:adapterOptions.project,userId:userInfo.user_id};if(!adapterOptions.project)return saveSession(sessionInfo),outSuccess.apply(this,[data]),void $d.resolve(data);var group=null;if(0===memberInfo.length)return void handleGroupError("The user has no groups associated in this account",401,data);if(1===memberInfo.length)group=memberInfo[0];else if(memberInfo.length>1&&groupId){var filteredGroups=$.grep(memberInfo,function(resGroup){return resGroup.groupId===groupId});group=1===filteredGroups.length?filteredGroups[0]:null}if(group){var groupSelection=group.groupId;data.groupSelection[adapterOptions.project]=groupSelection;var sessionInfoWithGroup=$.extend({},sessionInfo,{groupId:group.groupId,groupName:group.name,isFac:"facilitator"===_findUserInGroup(group.members,userInfo.user_id).role});saveSession(sessionInfoWithGroup),outSuccess.apply(this,[data]),$d.resolve(data)}else handleGroupError("This account is associated with more that one group. Please specify a group id to log into and try again",403,data)}).fail($d.reject)};return adapterOptions.success=handleSuccess,adapterOptions.error=function(response){return adapterOptions.account?(adapterOptions.account=null,adapterOptions.error=function(){outError.apply(this,arguments),$d.reject(response)},void _this.authAdapter.login(adapterOptions)):(outError.apply(this,arguments),void $d.reject(response))},this.authAdapter.login(adapterOptions),$d.promise()},logout:function(options){var $d=$.Deferred();var adapterOptions=$.extend(!0,{success:$.noop,token:token},this.options,options);var removeCookieFn=function(){store.remove(EPI_COOKIE_KEY,adapterOptions),store.remove(EPI_SESSION_KEY,adapterOptions),token=""};var outSuccess=adapterOptions.success;return adapterOptions.success=function(response){removeCookieFn(response),outSuccess.apply(this,arguments)},adapterOptions.error=function(response){removeCookieFn(response),outSuccess.apply(this,arguments),$d.resolve()},this.authAdapter.logout(adapterOptions).done($d.resolve),$d.promise()},getToken:function(options){var httpOptions=$.extend(!0,this.options,options);var $d=$.Deferred();return token?$d.resolve(token):this.login(httpOptions).then($d.resolve),$d.promise()},getUserGroups:function(params,options){var adapterOptions=$.extend(!0,{success:$.noop},this.options,options);var $d=$.Deferred();var outSuccess=adapterOptions.success;adapterOptions.success=function(memberInfo){adapterOptions.project&&(memberInfo=$.grep(memberInfo,function(group){return group.project===adapterOptions.project})),outSuccess.apply(this,[memberInfo]),$d.resolve(memberInfo)};var memberAdapter=new MemberAdapter({token:params.token});return memberAdapter.getGroupsByUser(params,adapterOptions).fail($d.reject),$d.promise()},getCurrentUserSessionInfo:function(options){return getSession(options)}}),module.exports=AuthManager;
},{"../service/auth-api-service":23,"../service/configuration-service":25,"../service/member-api-adapter":27,"../store/store-factory":34,"./key-names":9,"buffer":1}],7:[function(require,module,exports){
"use strict";var Channel=require("../service/channel-service");var ChannelManager=function(options){if(!$.cometd)throw new Error("Cometd library not found. Please include epicenter-multiplayer-dependencies.js");if(!options||!options.url)throw new Error("Please provide an url for the cometd server");var cometd=new $.Cometd;var defaults={url:"",logLevel:"info",websocketEnabled:!1,channel:{}};var defaultCometOptions=$.extend(!0,{},defaults,options);cometd.websocketEnabled=defaultCometOptions.websocketEnabled,this.isConnected=!1,this.currentSubscriptions=[],this.options=defaultCometOptions;var connectionBroken=function(message){$(this).trigger("disconnect",message)};var connectionSucceeded=function(message){$(this).trigger("connect",message)};var me=this;cometd.configure(defaultCometOptions),cometd.addListener("/meta/connect",function(message){var wasConnected=this.isConnected;this.isConnected=message.successful===!0,!wasConnected&&this.isConnected?connectionSucceeded.call(this,message):wasConnected&&!this.isConnected&&connectionBroken.call(this,message)}.bind(this)),cometd.addListener("/meta/disconnect",connectionBroken),cometd.addListener("/meta/handshake",function(message){message.successful&&cometd.batch(function(){$(me.currentSubscriptions).each(function(index,subs){cometd.resubscribe(subs)})})}),cometd.addListener("/meta/subscribe",function(message){$(me).trigger("subscribe",message)}),cometd.addListener("/meta/unsubscribe",function(message){$(me).trigger("unsubscribe",message)}),cometd.addListener("/meta/publish",function(message){$(me).trigger("publish",message)}),cometd.addListener("/meta/unsuccessful",function(message){$(me).trigger("error",message)}),cometd.handshake(),this.cometd=cometd};ChannelManager.prototype=$.extend(ChannelManager.prototype,{getChannel:function(options){options&&!$.isPlainObject(options)&&(options={base:options});var defaults={transport:this.cometd};var channel=new Channel($.extend(!0,{},this.options.channel,defaults,options));var subs=channel.subscribe;channel.subscribe=function(){var subid=subs.apply(channel,arguments);return this.currentSubscriptions=this.currentSubscriptions.concat(subid),subid}.bind(this);var unsubs=channel.unsubscribe;return channel.unsubscribe=function(){var removed=unsubs.apply(channel,arguments);for(var i=0;i<this.currentSubscriptions.length;i++)this.currentSubscriptions[i].id===removed.id&&this.currentSubscriptions.splice(i,1);return removed}.bind(this),channel},on:function(){$(this).on.apply($(this),arguments)},off:function(){$(this).off.apply($(this),arguments)},trigger:function(){$(this).trigger.apply($(this),arguments)}}),module.exports=ChannelManager;
},{"../service/channel-service":24}],8:[function(require,module,exports){
"use strict";var ChannelManager=require("./channel-manager");var classFrom=require("../util/inherit");var urlService=require("../service/url-config-service");var AuthManager=require("./auth-manager");var session=new AuthManager;var getFromSessionOrError=function(value,sessionKeyName){if(!value){var userInfo=session.getCurrentUserSessionInfo();if(!userInfo[sessionKeyName])throw new Error(sessionKeyName+" not found. Please log-in again, or specify "+sessionKeyName+" explicitly");value=userInfo[sessionKeyName]}return value};var __super=ChannelManager.prototype;var EpicenterChannelManager=classFrom(ChannelManager,{constructor:function(options){var userInfo=session.getCurrentUserSessionInfo();var defaults={server:{account:userInfo.account,project:userInfo.project}};var defaultCometOptions=$.extend(!0,{},defaults,userInfo,options);var urlOpts=urlService(defaultCometOptions.server);return defaultCometOptions.url||(defaultCometOptions.url=urlOpts.protocol+"://"+urlOpts.host+"/channel/subscribe"),this.options=defaultCometOptions,__super.constructor.call(this,defaultCometOptions)},getGroupChannel:function(groupName){groupName=getFromSessionOrError(groupName,"groupName");var baseTopic=["/group",this.options.server.account,this.options.server.project,groupName].join("/");return __super.getChannel.call(this,{base:baseTopic})},getWorldChannel:function(world,groupName){var worldid=$.isPlainObject(world)&&world.id?world.id:world;if(!worldid)throw new Error("Please specify a world id");groupName=getFromSessionOrError(groupName,"groupName");var baseTopic=["/world",this.options.server.account,this.options.server.project,groupName,worldid].join("/");return __super.getChannel.call(this,{base:baseTopic})},getUserChannel:function(world,user,groupName){var userid=$.isPlainObject(user)&&user.id?user.id:user;var worldid=$.isPlainObject(world)&&world.id?world.id:world;if(!worldid)throw new Error("Please specify a world id");userid=getFromSessionOrError(userid,"userId"),groupName=getFromSessionOrError(groupName,"groupName");var baseTopic=["/users",this.options.server.account,this.options.server.project,groupName,worldid,userid].join("/");return __super.getChannel.call(this,{base:baseTopic})}});module.exports=EpicenterChannelManager;
},{"../service/url-config-service":30,"../util/inherit":37,"./auth-manager":6,"./channel-manager":7}],9:[function(require,module,exports){
"use strict";module.exports={EPI_COOKIE_KEY:"epicenter.project.token",EPI_SESSION_KEY:"epicenter.user.session",STRATEGY_SESSION_KEY:"epicenter-scenario"};
},{}],10:[function(require,module,exports){
"use strict";function patchRunService(service,manager){if(service.patched)return service;var orig=service.do;return service.do=function(operation,params,options){var reservedOps=Object.keys(specialOperations);return-1===reservedOps.indexOf(operation)?orig.apply(service,arguments):specialOperations[operation].call(service,params,options,manager)},service.patched=!0,service}function RunManager(options){this.options=$.extend(!0,{},defaults,options),this.run=this.options.run instanceof RunService?this.options.run:new RunService(this.options.run),patchRunService(this.run,this);var StrategyCtor="function"==typeof this.options.strategy?this.options.strategy:strategiesMap[this.options.strategy];if(!StrategyCtor)throw new Error("Specified run creation strategy was invalid:",this.options.strategy);this.strategy=new StrategyCtor(this.run,this.options)}var strategiesMap=require("./run-strategies/strategies-map");var specialOperations=require("./special-operations");var RunService=require("../service/run-api-service");var defaults={strategy:"new-if-initialized"};RunManager.prototype={getRun:function(){return this.strategy.getRun()},reset:function(runServiceOptions){return this.strategy.reset(runServiceOptions)}},module.exports=RunManager;
},{"../service/run-api-service":28,"./run-strategies/strategies-map":19,"./special-operations":21}],11:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(runService,options){__super.constructor.call(this,runService,this.createIf,options)},createIf:function(){return!0}});module.exports=Strategy;
},{"../../util/inherit":37,"./conditional-creation-strategy":12}],12:[function(require,module,exports){
"use strict";function setRunInSession(sessionKey,run){var path="/"+[urlService.appPath,urlService.accountPath,urlService.projectPath].join("/");path=path.replace(/\/{2,}/g,"/"),sessionStore.set(sessionKey,JSON.stringify({runId:run.id}),{root:path})}var makeSeq=require("../../util/make-sequence");var Base=require("./identity-strategy");var SessionStore=require("../../store/store-factory");var classFrom=require("../../util/inherit");var UrlService=require("../../service/url-config-service");var sessionStore=new SessionStore({});var urlService=new UrlService;var keyNames=require("../key-names");var defaults={sessionKey:keyNames.STRATEGY_SESSION_KEY};var Strategy=classFrom(Base,{constructor:function(runService,condition,options){if(null==condition)throw new Error("Conditional strategy needs a condition to createte a run");this.run=makeSeq(runService),this.condition="function"!=typeof condition?function(){return condition}:condition,this.options=$.extend(!0,{},defaults,options),this.runOptions=this.options.run},reset:function(runServiceOptions){var _this=this;return this.run.create(this.runOptions,runServiceOptions).then(function(run){return setRunInSession(_this.options.sessionKey,run),run.freshlyCreated=!0,run}).start()},getRun:function(){var session=JSON.parse(sessionStore.get(this.options.sessionKey));return session&&session.runId?this._loadAndCheck(session):this.reset()},_loadAndCheck:function(session){var shouldCreate=!1;var _this=this;return this.run.load(session.runId,null,{success:function(run,msg,headers){shouldCreate=_this.condition.call(_this,run,headers)}}).then(function(run){return shouldCreate?_this.run.original.create(_this.runOptions).then(function(run){return setRunInSession(_this.options.sessionKey,run),run.freshlyCreated=!0,run}):run}).start()}});module.exports=Strategy;
},{"../../service/url-config-service":30,"../../store/store-factory":34,"../../util/inherit":37,"../../util/make-sequence":38,"../key-names":9,"./identity-strategy":13}],13:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var Base={};module.exports=classFrom(Base,{constructor:function(runService){this.runService=runService},reset:function(){return $.Deferred().resolve().promise()},getRun:function(){return $.Deferred().resolve(this.runService).promise()}});
},{"../../util/inherit":37}],14:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var IdentityStrategy=require("./identity-strategy");var WorldApiAdapter=require("../../service/world-api-adapter");var AuthManager=require("../auth-manager");var defaults={store:{synchronous:!0}};var Strategy=classFrom(IdentityStrategy,{constructor:function(runService,options){this.runService=runService,this.options=$.extend(!0,{},defaults,options),this._auth=new AuthManager,this._loadRun=this._loadRun.bind(this),this.worldApi=new WorldApiAdapter(this.options.run)},reset:function(){var session=this._auth.getCurrentUserSessionInfo();var curUserId=session.userId;var curGroupName=session.groupName;return this.worldApi.getCurrentWorldForUser(curUserId,curGroupName).then(function(world){return this.worldApi.newRunForWorld(world.id)}.bind(this))},getRun:function(){var session=this._auth.getCurrentUserSessionInfo();var curUserId=session.userId;var curGroupName=session.groupName;var worldApi=this.worldApi;var model=this.options.model;var _this=this;var dtd=$.Deferred();if(!curUserId)return dtd.reject({statusCode:400,error:"We need an authenticated user to join a multiplayer world. (ERR: no userId in session)"},session).promise();var loadRunFromWorld=function(world){return world?worldApi.getCurrentRunId({model:model,filter:world.id}).then(_this._loadRun).then(dtd.resolve).fail(dtd.reject):dtd.reject({statusCode:404,error:"The user is not in any world."},{options:this.options,session:session})};var serverError=function(error){dtd.reject(error,session,this.options)};return this.worldApi.getCurrentWorldForUser(curUserId,curGroupName).then(loadRunFromWorld).fail(serverError),dtd.promise()},_loadRun:function(id,options){return this.runService.load(id,null,options)}});module.exports=Strategy;
},{"../../service/world-api-adapter":32,"../../util/inherit":37,"../auth-manager":6,"./identity-strategy":13}],15:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(runService,options){__super.constructor.call(this,runService,this.createIf,options)},createIf:function(run,headers){return"persistent"===headers.getResponseHeader("pragma")||run.initialized}});module.exports=Strategy;
},{"../../util/inherit":37,"./conditional-creation-strategy":12}],16:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(runService,options){__super.constructor.call(this,runService,this.createIf,options)},createIf:function(){return!1}});module.exports=Strategy;
},{"../../util/inherit":37,"./conditional-creation-strategy":12}],17:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var ConditionalStrategy=require("./conditional-creation-strategy");var __super=ConditionalStrategy.prototype;var Strategy=classFrom(ConditionalStrategy,{constructor:function(runService,options){__super.constructor.call(this,runService,this.createIf,options)},createIf:function(run,headers){return"persistent"===headers.getResponseHeader("pragma")}});module.exports=Strategy;
},{"../../util/inherit":37,"./conditional-creation-strategy":12}],18:[function(require,module,exports){
"use strict";var classFrom=require("../../util/inherit");var IdentityStrategy=require("./identity-strategy");var StorageFactory=require("../../store/store-factory");var StateApi=require("../../service/state-api-adapter");var keyNames=require("../key-names");var defaults={store:{synchronous:!0}};var Strategy=classFrom(IdentityStrategy,{constructor:function(runService,options){this.run=runService,this.options=$.extend(!0,{},defaults,options),this.runOptions=this.options.run,this._store=new StorageFactory(this.options.store),this.stateApi=new StateApi,this._loadAndCheck=this._loadAndCheck.bind(this),this._restoreRun=this._restoreRun.bind(this),this._getAllRuns=this._getAllRuns.bind(this),this._loadRun=this._loadRun.bind(this)},reset:function(runServiceOptions){return this.run.create(this.runOptions,runServiceOptions).then(function(run){return run.freshlyCreated=!0,run})},getRun:function(){return this._getAllRuns().then(this._loadAndCheck)},_getAllRuns:function(){var session=JSON.parse(this._store.get(keyNames.EPI_SESSION_KEY)||"{}");return this.run.query({"user.id":session.userId||"0000","scope.group":session.groupName})},_loadAndCheck:function(runs){if(!runs||!runs.length)return this.reset();var dateComp=function(a,b){return new Date(b.date)-new Date(a.date)};var latestRun=runs.sort(dateComp)[0];var _this=this;var shouldReplay=!1;return this.run.load(latestRun.id,null,{success:function(run,msg,headers){shouldReplay="persistent"===headers.getResponseHeader("pragma")}}).then(function(run){return shouldReplay?_this._restoreRun(run.id):run})},_restoreRun:function(runId){var _this=this;return this.stateApi.replay({runId:runId}).then(function(resp){return _this._loadRun(resp.run)})},_loadRun:function(id,options){return this.run.load(id,null,options)}});module.exports=Strategy;
},{"../../service/state-api-adapter":29,"../../store/store-factory":34,"../../util/inherit":37,"../key-names":9,"./identity-strategy":13}],19:[function(require,module,exports){
module.exports={"new-if-initialized":require("./new-if-initialized-strategy"),"new-if-persisted":require("./new-if-persisted-strategy"),"new-if-missing":require("./new-if-missing-strategy"),"always-new":require("./always-new-strategy"),multiplayer:require("./multiplayer-strategy"),"persistent-single-player":require("./persistent-single-player-strategy"),none:require("./identity-strategy")};
},{"./always-new-strategy":11,"./identity-strategy":13,"./multiplayer-strategy":14,"./new-if-initialized-strategy":15,"./new-if-missing-strategy":16,"./new-if-persisted-strategy":17,"./persistent-single-player-strategy":18}],20:[function(require,module,exports){
"use strict";function ScenarioManager(options){this.options=$.extend(!0,{},defaults,options),this.runService=this.options.run||new RunService(this.options)}var RunService=require("../service/run-api-service");var defaults={validFilter:{saved:!0}};ScenarioManager.prototype={getRuns:function(filter){return this.filter=$.extend(!0,{},this.options.validFilter,filter),this.runService.query(this.filter)},loadVariables:function(vars){return this.runService.query(this.filter,{include:vars})},save:function(run,meta){return this._getService(run).save($.extend(!0,{},{saved:!0},meta))},archive:function(run){return this._getService(run).save({saved:!1})},_getService:function(run){if("string"==typeof run)return new RunService($.extend(!0,{},this.options,{filter:run}));if("object"==typeof run&&run instanceof RunService)return run;throw new Error("Save method requires a run service or a runId")},getRun:function(runId){return new RunService($.extend(!0,{},this.options,{filter:runId}))}},module.exports=ScenarioManager;
},{"../service/run-api-service":28}],21:[function(require,module,exports){
"use strict";module.exports={reset:function(params,options,manager){return manager.reset(options)}};
},{}],22:[function(require,module,exports){
"use strict";function buildStrategy(worldId,dtd){return function(runService,options){this.runService=runService,this.options=options,$.extend(this,{reset:function(){throw new Error("not implementd. Need api changes")},getRun:function(){var _this=this;return worldApi.getCurrentRunId({model:this.options.model,filter:worldId}).then(function(runId){return _this.runService.load(runId)}).then(function(run){dtd.resolve.call(this,run,_this.runService)}).fail(dtd.reject)}})}}var WorldApi=require("../service/world-api-adapter");var RunManager=require("./run-manager");var AuthManager=require("./auth-manager");var worldApi;module.exports=function(options){this.options=options||{run:{},world:{}},$.extend(!0,this.options,this.options.run),$.extend(!0,this.options,this.options.world),worldApi=new WorldApi(this.options),this._auth=new AuthManager;var _this=this;var api={getCurrentWorld:function(userId,groupName){var session=this._auth.getCurrentUserSessionInfo();return userId||(userId=session.userId),groupName||(groupName=session.groupName),worldApi.getCurrentWorldForUser(userId,groupName)},getCurrentRun:function(model){function getAndRestoreLatestRun(world){var currentWorldId=world.id;var runOpts=$.extend(!0,_this.options,{model:model});var strategy=buildStrategy(currentWorldId,dtd);var opt=$.extend(!0,{},{strategy:strategy,run:runOpts});var rm=new RunManager(opt);return rm.getRun().then(function(run){dtd.resolve(run,rm.runService,rm)})}var dtd=$.Deferred();var session=this._auth.getCurrentUserSessionInfo();var curUserId=session.userId;var curGroupName=session.groupName;return this.getCurrentWorld(curUserId,curGroupName).then(getAndRestoreLatestRun),dtd.promise()}};$.extend(this,api)};
},{"../service/world-api-adapter":32,"./auth-manager":6,"./run-manager":10}],23:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");module.exports=function(config){var defaults={userName:"",password:"",account:"",transport:{}};var serviceOptions=$.extend({},defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath("authentication")});var http=new TransportFactory(transportOptions);var publicAPI={login:function(options){var httpOptions=$.extend(!0,{success:$.noop},serviceOptions,options);if(!httpOptions.userName||!httpOptions.password){var resp={status:401,statusMessage:"No username or password specified."};return options.error&&options.error.call(this,resp),$.Deferred().reject(resp).promise()}var postParams={userName:httpOptions.userName,password:httpOptions.password};return httpOptions.account&&(postParams.account=httpOptions.account),http.post(postParams,httpOptions)},logout:function(options){var httpOptions=$.extend(!0,serviceOptions,transportOptions,options);if(!httpOptions.token)throw new Error("No token was specified.");var slash="/"===httpOptions.url.slice(-1)?"":"/";httpOptions.url=httpOptions.url+slash+httpOptions.token;var deleteParams={};return http.delete(deleteParams,httpOptions)}};$.extend(this,publicAPI)};
},{"../transport/http-transport-factory":36,"./configuration-service":25}],24:[function(require,module,exports){
"use strict";var Channel=function(options){var defaults={base:"",topicResolver:function(topic){return topic},transport:null};this.channelOptions=$.extend(!0,{},defaults,options)};var makeName=function(channelName,topic){var newName=(channelName?channelName+"/"+topic:topic).replace(/\/\//g,"/").replace(/\/$/,"");return newName};Channel.prototype=$.extend(Channel.prototype,{subscribe:function(topic,callback){var topics=[].concat(topic);var me=this;var subscriptionIds=[];var opts=me.channelOptions;return opts.transport.batch(function(){$.each(topics,function(index,topic){topic=makeName(opts.base,opts.topicResolver(topic)),subscriptionIds.push(opts.transport.subscribe(topic,callback))})}),subscriptionIds[1]?subscriptionIds:subscriptionIds[0]},publish:function(topic,data){var topics=[].concat(topic);var me=this;var returnObjs=[];var opts=me.channelOptions;return opts.transport.batch(function(){$.each(topics,function(index,topic){topic=makeName(opts.base,opts.topicResolver(topic)),"*"===topic.charAt(topic.length-1)&&(topic=topic.replace(/\*+$/,""),console.warn("You can cannot publish to channels with wildcards. Publishing to ",topic,"instead")),returnObjs.push(opts.transport.publish(topic,data))})}),returnObjs[1]?returnObjs:returnObjs[0]},unsubscribe:function(token){return this.channelOptions.transport.unsubscribe(token),token}}),module.exports=Channel;
},{}],25:[function(require,module,exports){
"use strict";var urlService=require("./url-config-service");module.exports=function(config){var defaults={logLevel:"NONE"};var serviceOptions=$.extend({},defaults,config);return serviceOptions.server=urlService(serviceOptions.server),{data:serviceOptions,setEnv:function(){},get:function(property){return serviceOptions[property]},set:function(key,value){serviceOptions[key]=value}}};
},{"./url-config-service":30}],26:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var StorageFactory=require("../store/store-factory");var qutil=require("../util/query-util");var TransportFactory=require("../transport/http-transport-factory");module.exports=function(config){var store=new StorageFactory({synchronous:!0});var defaults={root:"/",token:store.get("epicenter.project.token")||"",apiKey:"",domain:"forio.com",transport:{}};var serviceOptions=$.extend({},defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account&&(urlConfig.accountPath=serviceOptions.account),serviceOptions.project&&(urlConfig.projectPath=serviceOptions.project);var getURL=function(key,root){root||(root=serviceOptions.root);var url=urlConfig.getAPIPath("data")+qutil.addTrailingSlash(root);return key&&(url+=qutil.addTrailingSlash(key)),url};var httpOptions=$.extend(!0,{},serviceOptions.transport,{url:getURL});serviceOptions.token&&(httpOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(httpOptions);var publicAPI={query:function(key,query,outputModifier,options){var params=$.extend(!0,{q:query},outputModifier);var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL(key,httpOptions.root),http.get(params,httpOptions)},save:function(key,value,options){var attrs;"object"==typeof key?(attrs=key,options=value):(attrs={})[key]=value;var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL("",httpOptions.root),http.post(attrs,httpOptions)},saveAs:function(key,value,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL(key,httpOptions.root),http.put(value,httpOptions)},load:function(key,outputModifier,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return httpOptions.url=getURL(key,httpOptions.root),http.get(outputModifier,httpOptions)},remove:function(keys,options){var httpOptions=$.extend(!0,{},serviceOptions,options);var params;return $.isArray(keys)?params={id:keys}:(params="",httpOptions.url=getURL(keys,httpOptions.root)),http.delete(params,httpOptions)}};$.extend(this,publicAPI)};
},{"../store/store-factory":34,"../transport/http-transport-factory":36,"../util/query-util":40,"./configuration-service":25}],27:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var _pick=require("../util/object-util")._pick;var apiEndpoint="member/local";module.exports=function(config){var defaults={userId:"",groupId:"",transport:{}};var serviceOptions=$.extend({},defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions,serviceOptions);var getFinalParams=function(params){return"object"==typeof params?$.extend(!0,serviceOptions,params):serviceOptions};var publicAPI={getGroupsByUser:function(params,options){options=options||{};var httpOptions=$.extend(!0,serviceOptions,options);var isString="string"==typeof params;var objParams=getFinalParams(params);if(!isString&&!objParams.userId)throw new Error("No userId specified.");var getParms=isString?{userId:params}:_pick(objParams,"userId");return http.get(getParms,httpOptions)},getGroupDetails:function(params,options){options=options||{};var isString="string"==typeof params;var objParams=getFinalParams(params);if(!isString&&!objParams.groupId)throw new Error("No groupId specified.");var groupId=isString?params:objParams.groupId;var httpOptions=$.extend(!0,serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+groupId});return http.get({},httpOptions)}};$.extend(this,publicAPI)};
},{"../transport/http-transport-factory":36,"../util/object-util":39,"./configuration-service":25}],28:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var StorageFactory=require("../store/store-factory");var qutil=require("../util/query-util");var rutil=require("../util/run-util");var _pick=require("../util/object-util")._pick;var TransportFactory=require("../transport/http-transport-factory");var VariablesService=require("./variables-api-service");module.exports=function(config){var store=new StorageFactory({synchronous:!0});var defaults={token:store.get("epicenter.project.token")||"",account:"",project:"",filter:"",success:$.noop,error:$.noop,transport:{}};var serviceOptions=$.extend({},defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");serviceOptions.account&&(urlConfig.accountPath=serviceOptions.account),serviceOptions.project&&(urlConfig.projectPath=serviceOptions.project),urlConfig.filter=";",urlConfig.getFilterURL=function(){var url=urlConfig.getAPIPath("run");var filter=qutil.toMatrixFormat(serviceOptions.filter);return filter&&(url+=filter+"/"),url};var httpOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getFilterURL});serviceOptions.token&&(httpOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(httpOptions);var setFilterOrThrowError=function(options){if(options.filter&&(serviceOptions.filter=options.filter),!serviceOptions.filter)throw new Error("No filter specified to apply operations against")};var publicAsyncAPI={urlConfig:urlConfig,create:function(params,options){var createOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath("run")});var runApiParams=["model","scope","files"];params="string"==typeof params?{model:params}:_pick(params,runApiParams);var oldSuccess=createOptions.success;return createOptions.success=function(response){return serviceOptions.filter=response.id,oldSuccess.apply(this,arguments)},http.post(params,createOptions)},query:function(qs,outputModifier,options){serviceOptions.filter=qs;var httpOptions=$.extend(!0,{},serviceOptions,options);return http.get(outputModifier,httpOptions)},filter:function(filter,outputModifier,options){$.isPlainObject(serviceOptions.filter)?$.extend(serviceOptions.filter,filter):serviceOptions.filter=filter;var httpOptions=$.extend(!0,{},serviceOptions,options);return http.get(outputModifier,httpOptions)},load:function(runID,filters,options){serviceOptions.filter=runID;var httpOptions=$.extend(!0,{},serviceOptions,options);return http.get(filters,httpOptions)},save:function(attributes,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return setFilterOrThrowError(httpOptions),http.patch(attributes,httpOptions)},"do":function(operation,params,options){var opsArgs;var postOptions;options?(opsArgs=params,postOptions=options):$.isPlainObject(params)?(opsArgs=null,postOptions=params):opsArgs=params;var result=rutil.normalizeOperations(operation,opsArgs);var httpOptions=$.extend(!0,{},serviceOptions,postOptions);setFilterOrThrowError(httpOptions);var prms=result.args[0].length&&null!==result.args[0]&&void 0!==result.args[0]?result.args[0]:[];return http.post({arguments:prms},$.extend(!0,{},httpOptions,{url:urlConfig.getFilterURL()+"operations/"+result.ops[0]+"/"}))},serial:function(operations,params,options){var opParams=rutil.normalizeOperations(operations,params);var ops=opParams.ops;var args=opParams.args;var me=this;var $d=$.Deferred();var postOptions=$.extend(!0,{},serviceOptions,options);var doSingleOp=function(){var op=ops.shift();var arg=args.shift();me.do(op,arg,{success:function(){ops.length?doSingleOp():($d.resolve.apply(this,arguments),postOptions.success.apply(this,arguments))},error:function(){$d.reject.apply(this,arguments),postOptions.error.apply(this,arguments)}})};return doSingleOp(),$d.promise()},parallel:function(operations,params,options){var $d=$.Deferred();var opParams=rutil.normalizeOperations(operations,params);var ops=opParams.ops;var args=opParams.args;var postOptions=$.extend(!0,{},serviceOptions,options);var queue=[];for(var i=0;i<ops.length;i++)queue.push(this.do(ops[i],args[i]));return $.when.apply(this,queue).done(function(){$d.resolve.apply(this,arguments),postOptions.success.apply(this.arguments)}).fail(function(){$d.reject.apply(this,arguments),postOptions.error.apply(this.arguments)}),$d.promise()}};var publicSyncAPI={variables:function(config){var vs=new VariablesService($.extend(!0,{},serviceOptions,config,{runService:this}));return vs}};$.extend(this,publicAsyncAPI),$.extend(this,publicSyncAPI)};
},{"../store/store-factory":34,"../transport/http-transport-factory":36,"../util/object-util":39,"../util/query-util":40,"../util/run-util":41,"./configuration-service":25,"./variables-api-service":31}],29:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var TransportFactory=require("../transport/http-transport-factory");var _pick=require("../util/object-util")._pick;var apiEndpoint="model/state";module.exports=function(config){var defaults={};var serviceOptions=$.extend({},defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions);var publicAPI={replay:function(params,options){var replayOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+params.runId});return params=$.extend(!0,{action:"replay"},_pick(params,"stopBefore")),http.post(params,replayOptions)},clone:function(params,options){var replayOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+params.runId});return params=$.extend(!0,{action:"clone"},_pick(params,"stopBefore")),http.post(params,replayOptions)}};$.extend(this,publicAPI)};
},{"../transport/http-transport-factory":36,"../util/object-util":39,"./configuration-service":25}],30:[function(require,module,exports){
"use strict";module.exports=function(config){var API_PROTOCOL="https";var HOST_API_MAPPING={"forio.com":"api.forio.com","foriodev.com":"api.epicenter.foriodev.com"};var publicExports={protocol:API_PROTOCOL,api:"",host:function(){var host=window.location.host;return host&&-1===host.indexOf("local")||(host="forio.com"),HOST_API_MAPPING[host]?HOST_API_MAPPING[host]:"api."+host}(),appPath:function(){var path=window.location.pathname.split("/");return path&&path[1]||""}(),accountPath:function(){var accnt="";var path=window.location.pathname.split("/");return path&&"app"===path[1]&&(accnt=path[2]),accnt}(),projectPath:function(){var prj="";var path=window.location.pathname.split("/");return path&&"app"===path[1]&&(prj=path[3]),prj}(),getAPIPath:function(api){var PROJECT_APIS=["run","data"];var apiPath=this.protocol+"://"+this.host+"/"+api+"/";return-1!==$.inArray(api,PROJECT_APIS)&&(apiPath+=this.accountPath+"/"+this.projectPath+"/"),apiPath}};return $.extend(publicExports,config),publicExports};
},{}],31:[function(require,module,exports){
"use strict";var TransportFactory=require("../transport/http-transport-factory");module.exports=function(config){var defaults={runService:null};var serviceOptions=$.extend({},defaults,config);var getURL=function(){return serviceOptions.runService.urlConfig.getFilterURL()+"variables/"};var httpOptions={url:getURL};serviceOptions.token&&(httpOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(httpOptions);var publicAPI={load:function(variable,outputModifier,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return http.get(outputModifier,$.extend({},httpOptions,{url:getURL()+variable+"/"}))},query:function(query,outputModifier,options){var httpOptions=$.extend(!0,{},serviceOptions,options);return $.isArray(query)&&(query={include:query}),$.extend(query,outputModifier),http.get(query,httpOptions)},save:function(variable,val,options){var attrs;"object"==typeof variable?(attrs=variable,options=val):(attrs={})[variable]=val;var httpOptions=$.extend(!0,{},serviceOptions,options);return http.patch.call(this,attrs,httpOptions)}};$.extend(this,publicAPI)};
},{"../transport/http-transport-factory":36}],32:[function(require,module,exports){
"use strict";var ConfigService=require("./configuration-service");var StorageFactory=require("../store/store-factory");var TransportFactory=require("../transport/http-transport-factory");var _pick=require("../util/object-util")._pick;var apiEndpoint="multiplayer/world";module.exports=function(config){var store=new StorageFactory({synchronous:!0});var defaults={token:store.get("epicenter.project.token")||"",project:void 0,account:void 0,group:void 0,model:void 0,transport:{},success:$.noop,error:$.noop};var serviceOptions=$.extend({},defaults,config);var urlConfig=new ConfigService(serviceOptions).get("server");var transportOptions=$.extend(!0,{},serviceOptions.transport,{url:urlConfig.getAPIPath(apiEndpoint)});serviceOptions.token&&(transportOptions.headers={Authorization:"Bearer "+serviceOptions.token});var http=new TransportFactory(transportOptions);var setIdFilterOrThrowError=function(options){if(options.filter&&(serviceOptions.filter=options.filter),!serviceOptions.filter)throw new Error("No filter specified to apply operations against")};var validateModelOrThrowError=function(options){if(!options.model)throw new Error("No model specified to get the current run")};var publicAPI={create:function(params,options){var createOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)});var worldApiParams=["scope","files","roles","optionalRoles","minUsers","group","name"];params=_pick(params,worldApiParams),$.extend(params,_pick(serviceOptions,["account","project","group"]));var oldSuccess=createOptions.success;return createOptions.success=function(response){return serviceOptions.filter=response.id,oldSuccess.apply(this,arguments)},http.post(params,createOptions)},update:function(params,options){var whitelist=["roles","optionalRoles","minUsers"];options=options||{},setIdFilterOrThrowError(options);var updateOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter});return params=_pick(params||{},whitelist),http.patch(params,updateOptions)},"delete":function(options){options=options||{},setIdFilterOrThrowError(options);var deleteOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter});return http.delete(null,deleteOptions)},list:function(options){options=options||{};var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)});var filters=_pick(getOptions,["account","project","group"]);return http.get(filters,getOptions)},getWorldsForUser:function(userId,options){options=options||{};var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)});var filters=$.extend(_pick(getOptions,["account","project","group"]),{userId:userId});return http.get(filters,getOptions)},addUsers:function(users,worldId,options){if(!users)throw new Error("Please provide a list of users to add to the world");users=$.map([].concat(users),function(u){var isObject=$.isPlainObject(u);if("string"!=typeof u&&!isObject)throw new Error("Some of the users in the list are not in the valid format: "+u);return isObject?u:{userId:u}}),$.isPlainObject(worldId)&&!options&&(options=worldId,worldId=null),options=options||{},"string"==typeof worldId&&(options.filter=worldId),setIdFilterOrThrowError(options);var updateOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/users"});return http.post(users,updateOptions)},removeUser:function(user,options){if(options=options||{},"string"==typeof user&&(user={userId:user}),!user.userId)throw new Error("You need to pass a userId to remove from the world");setIdFilterOrThrowError(options);var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/users/"+user.userId});return http.delete(null,getOptions)},getCurrentRunId:function(options){options=options||{},setIdFilterOrThrowError(options);var getOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/run"});return validateModelOrThrowError(getOptions),http.post(_pick(getOptions,"model"),getOptions)},getCurrentWorldForUser:function(userId,groupName){var dtd=$.Deferred();var me=this;return this.getWorldsForUser(userId,{group:groupName}).then(function(worlds){worlds.sort(function(a,b){return new Date(b.lastModified)-new Date(a.lastModified)});var currentWorld=worlds[0];dtd.resolve(currentWorld,me)}).fail(dtd.reject),dtd.promise()},deleteRun:function(worldId,options){options=options||{},worldId&&(options.filter=worldId),setIdFilterOrThrowError(options);var deleteOptions=$.extend(!0,{},serviceOptions,options,{url:urlConfig.getAPIPath(apiEndpoint)+serviceOptions.filter+"/run"});return http.delete(null,deleteOptions)},newRunForWorld:function(worldId,options){var currentRunOptions=$.extend(!0,{},options,{filter:worldId});return validateModelOrThrowError(currentRunOptions),this.deleteRun(worldId,options).then(function(){return this.getCurrentRunId(currentRunOptions)})}};$.extend(this,publicAPI)};
},{"../store/store-factory":34,"../transport/http-transport-factory":36,"../util/object-util":39,"./configuration-service":25}],33:[function(require,module,exports){
"use strict";module.exports=function(config){var defaults={root:"/",domain:".forio.com"};var serviceOptions=$.extend({},defaults,config);var publicAPI={set:function(key,value,options){var setOptions=$.extend(!0,{},serviceOptions,options);var domain=setOptions.domain;var path=setOptions.root;return document.cookie=encodeURIComponent(key)+"="+encodeURIComponent(value)+(domain?"; domain="+domain:"")+(path?"; path="+path:""),value},get:function(key){var cookieReg=new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(key).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$");var val=document.cookie.replace(cookieReg,"$1");return val=decodeURIComponent(val)||null},remove:function(key,options){var remOptions=$.extend(!0,{},serviceOptions,options);var domain=remOptions.domain;var path=remOptions.root;return document.cookie=encodeURIComponent(key)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(domain?"; domain="+domain:"")+(path?"; path="+path:""),key},destroy:function(){var aKeys=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/);for(var nIdx=0;nIdx<aKeys.length;nIdx++){var cookieKey=decodeURIComponent(aKeys[nIdx]);this.remove(cookieKey)}return aKeys}};$.extend(this,publicAPI)};
},{}],34:[function(require,module,exports){
"use strict";var store=require("./cookie-store");module.exports=store;
},{"./cookie-store":33}],35:[function(require,module,exports){
"use strict";var qutils=require("../util/query-util");module.exports=function(config){var defaults={url:"",contentType:"application/json",headers:{},statusCode:{404:$.noop},parameterParser:qutils.toQueryFormat,xhrFields:{withCredentials:!0}};var transportOptions=$.extend({},defaults,config);var result=function(d){return $.isFunction(d)?d():d};var connect=function(method,params,connectOptions){params=result(params),params=$.isPlainObject(params)||$.isArray(params)?JSON.stringify(params):params;var options=$.extend(!0,{},transportOptions,connectOptions,{type:method,data:params});var ALLOWED_TO_BE_FUNCTIONS=["data","url"];if($.each(options,function(key,value){$.isFunction(value)&&-1!==$.inArray(key,ALLOWED_TO_BE_FUNCTIONS)&&(options[key]=value())}),options.logLevel&&"DEBUG"===options.logLevel){console.log(options.url);var oldSuccessFn=options.success||$.noop;options.success=function(response){console.log(response),oldSuccessFn.apply(this,arguments)}}var beforeSend=options.beforeSend;return options.beforeSend=function(xhr){xhr.requestUrl=(connectOptions||{}).url,beforeSend&&beforeSend.apply(this,arguments)},$.ajax(options)};var publicAPI={get:function(params,ajaxOptions){var options=$.extend({},transportOptions,ajaxOptions);return params=options.parameterParser(result(params)),connect.call(this,"GET",params,options)},post:function(){return connect.apply(this,["post"].concat([].slice.call(arguments)))},patch:function(){return connect.apply(this,["patch"].concat([].slice.call(arguments)))},put:function(){return connect.apply(this,["put"].concat([].slice.call(arguments)))},"delete":function(params,ajaxOptions){var options=$.extend({},transportOptions,ajaxOptions);if(params=options.parameterParser(result(params)),$.trim(params)){var delimiter=-1===result(options.url).indexOf("?")?"?":"&";options.url=result(options.url)+delimiter+params}return connect.call(this,"DELETE",null,options)},head:function(){return connect.apply(this,["head"].concat([].slice.call(arguments)))},options:function(){return connect.apply(this,["options"].concat([].slice.call(arguments)))}};return $.extend(this,publicAPI)};
},{"../util/query-util":40}],36:[function(require,module,exports){
"use strict";var transport=require("./ajax-http-transport");module.exports=transport;
},{"./ajax-http-transport":35}],37:[function(require,module,exports){
"use strict";function inherit(C,P){var F=function(){};F.prototype=P.prototype,C.prototype=new F,C.__super=P.prototype,C.prototype.constructor=C}var extend=function(dest){var obj=Array.prototype.slice.call(arguments,1);var current;for(var j=0;j<obj.length;j++)if(current=obj[j])for(var key in current)dest[key]=current[key];return dest};module.exports=function(base,props,staticProps){var parent=base;var child;return child=props&&props.hasOwnProperty("constructor")?props.constructor:function(){return parent.apply(this,arguments)},extend(child,parent,staticProps),inherit(child,parent),props&&extend(child.prototype,props),child};
},{}],38:[function(require,module,exports){
"use strict";function _w(val){if(val&&val.then)return val;var p=$.Deferred();return p.resolve(val),p.promise()}function seq(){function next(p){var cur=list.splice(0,1)[0];return cur?_w(cur(p)).then(next):p}var list=Array.prototype.slice.apply(arguments);return function(seed){return next(seed).fail(seq.fail)}}function MakeSeq(obj){var res={__calls:[],original:obj,then:function(fn){return this.__calls.push(fn),this},start:function(){var _this=this;return this.then(function(run){return _this.__calls.length=0,run}),seq.apply(null,this.__calls)()},fail:function(fn){return seq.fail=fn,this}};var funcMaker=function(p,obj){var fn=obj[p].bind(obj);return function(){var args=Array.prototype.slice.apply(arguments);return this.__calls.push(Function.bind.apply(fn,[null].concat(args))),this}};for(var prop in obj)res[prop]="function"==typeof obj[prop]?funcMaker(prop,obj):obj[prop];return res}module.exports=MakeSeq;
},{}],39:[function(require,module,exports){
"use strict";module.exports={_pick:function(obj,props){var res={};for(var p in obj)-1!==props.indexOf(p)&&(res[p]=obj[p]);return res}};
},{}],40:[function(require,module,exports){
"use strict";module.exports=function(){return{toMatrixFormat:function(qs){if(null===qs||void 0===qs||""===qs)return";";if("string"==typeof qs||qs instanceof String)return qs;var returnArray=[];var OPERATORS=["<",">","!"];$.each(qs,function(key,value){("string"!=typeof value||-1===$.inArray($.trim(value).charAt(0),OPERATORS))&&(value="="+value),returnArray.push(key+value)});var mtrx=";"+returnArray.join(";");return mtrx},toQueryFormat:function(qs){if(null===qs||void 0===qs)return"";if("string"==typeof qs||qs instanceof String)return qs;var returnArray=[];$.each(qs,function(key,value){$.isArray(value)&&(value=value.join(",")),$.isPlainObject(value)&&(value=JSON.stringify(value)),returnArray.push(key+"="+value)});var result=returnArray.join("&");return result},qsToObject:function(qs){if(null===qs||void 0===qs||""===qs)return{};var qsArray=qs.split("&");var returnObj={};return $.each(qsArray,function(index,value){var qKey=value.split("=")[0];var qVal=value.split("=")[1];-1!==qVal.indexOf(",")&&(qVal=qVal.split(",")),returnObj[qKey]=qVal}),returnObj},mergeQS:function(qs1,qs2){var obj1=this.qsToObject(this.toQueryFormat(qs1));var obj2=this.qsToObject(this.toQueryFormat(qs2));return $.extend(!0,{},obj1,obj2)},addTrailingSlash:function(url){return url?"/"===url.charAt(url.length-1)?url:url+"/":""}}}();
},{}],41:[function(require,module,exports){
"use strict";module.exports=function(){return{normalizeOperations:function(operations,args){args||(args=[]);var returnList={ops:[],args:[]};var _concat=function(arr){return null!==arr&&void 0!==arr?[].concat(arr):[]};var _normalizePlainObjects=function(operations,returnList){return returnList||(returnList={ops:[],args:[]}),$.each(operations,function(opn,arg){returnList.ops.push(opn),returnList.args.push(_concat(arg))}),returnList};var _normalizeStructuredObjects=function(operation,returnList){return returnList||(returnList={ops:[],args:[]}),returnList.ops.push(operation.name),returnList.args.push(_concat(operation.params)),returnList};var _normalizeObject=function(operation,returnList){return(operation.name?_normalizeStructuredObjects:_normalizePlainObjects)(operation,returnList)};var _normalizeLiterals=function(operation,args,returnList){return returnList||(returnList={ops:[],args:[]}),returnList.ops.push(operation),returnList.args.push(_concat(args)),returnList};var _normalizeArrays=function(operations,arg,returnList){return returnList||(returnList={ops:[],args:[]}),$.each(operations,function(index,opn){$.isPlainObject(opn)?_normalizeObject(opn,returnList):_normalizeLiterals(opn,args[index],returnList)}),returnList};return $.isPlainObject(operations)?_normalizeObject(operations,returnList):$.isArray(operations)?_normalizeArrays(operations,args,returnList):_normalizeLiterals(operations,args,returnList),returnList}}}();
},{}]},{},[5])


//# sourceMappingURL=epicenter.min.js.map