!function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}var installedModules={};__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{configurable:!1,enumerable:!0,get:getter})},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=6)}([function(module,exports,__webpack_require__){"use strict";function inherit(C,P){var F=function(){};F.prototype=P.prototype,C.prototype=new F,C.__super=P.prototype,C.prototype.constructor=C}var extend=function(dest){var obj=Array.prototype.slice.call(arguments,1);var current;for(var j=0;j<obj.length;j++)if(current=obj[j])for(var key in current)dest[key]=current[key];return dest};module.exports=function(base,props,staticProps){var parent=base;var child;return child=props&&props.hasOwnProperty("constructor")?props.constructor:function(){return parent.apply(this,arguments)},extend(child,parent,staticProps),inherit(child,parent),props&&extend(child.prototype,props),child}},function(module,exports,__webpack_require__){"use strict";var env=__webpack_require__(3);var cache={};module.exports={worldApi:function(){return cache.worldApi||(cache.worldApi=new F.service.World(env.get())),cache.worldApi},memberApi:function(){return cache.memberApi||(cache.memberApi=new F.service.Member(_.pick(env.get(),["groupId","server"]))),cache.memberApi},userApi:function(){return cache.userApi||(cache.userApi=new F.service.User(_.pick(env.get(),["account","server"]))),cache.userApi}}},function(module,exports,__webpack_require__){"use strict";var BaseModel=function(attr,options){attr=_.defaults({},attr,_.result(this,"defaults")),this._data={},this.set(attr,options),this.initialize.apply(this,arguments)};_.extend(BaseModel.prototype,{initialize:function(attr,options){},set:function(key,val,options){if(null===key)return this;var attrs;return"object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options=options||{},_.extend(this._data,attrs),this},get:function(key,options){return this._data[key]},remove:function(){return this.collection&&this.collection.remove(this),this},toJSON:function(){return this._data},pick:function(keys){return _.pick(this._data,keys)}}),module.exports=BaseModel},function(module,exports,__webpack_require__){"use strict";var env={account:"",project:"",group:"",groupId:"",token:"",server:{host:"api.forio.com",protocol:"https"}};module.exports={set:function(options){env=_.merge(env,options)},get:function(){return env}}},function(module,exports,__webpack_require__){"use strict";var classFrom=__webpack_require__(0);var Base=__webpack_require__(2);var serviceLocator=__webpack_require__(1);module.exports=classFrom(Base,{defaults:{world:"",role:"",active:!0,isWorldComplete:!0,firstName:"",lastName:""},makeActive:function(){var memberApi=serviceLocator.memberApi();var params={userId:this.get("id"),groupId:this.get("groupId")};var original=this.get("active");return this.set("active",!0),memberApi.makeUserActive(params).fail(function(){this.set("active",original)}.bind(this))},makeInactive:function(){var memberApi=serviceLocator.memberApi();var params={userId:this.get("id"),groupId:this.get("groupId")};var original=this.get("active");return this.set("active",!1),memberApi.makeUserInactive(params).fail(function(){this.set("active",original)}.bind(this))}})},function(module,exports,__webpack_require__){"use strict";var BaseCollection=function(models,options){this._models=[],this.options=options,this.initialize.apply(this,arguments)};_.extend(BaseCollection.prototype,{idAttribute:"id",initialize:function(models,options){},create:function(attr,options){var m=new this.model(attr,options);return this.set(m),m},reset:function(models,options){this._models.length=0,this.set(models)},remove:function(model){return _.remove(this._models,function(m){return m===model}),delete model.collection,model},set:function(models){var _this=this;if(models&&(models=[].concat(models),models.length))return models.forEach(function(m){m instanceof _this.model||(m=new _this.model(m)),m.collection=_this,_this._models.push(m)}),this.sort(),models},sortFn:function(a,b){return b._data[this.idAttribute]-a._data[this.idAttribute]},sort:function(){return this._models=this._models.sort(this.sortFn.bind(this)),this._models},getById:function(id){var _this2=this;return _.find(this._models,function(m){return m.get(_this2.idAttribute)===id})},each:function(cb,ctx){return _.each(this._models,cb,ctx||this)},all:function(cb,ctx){return _.every(this._models,cb,ctx||this)},toJSON:function(){return _.invoke(this._models,"toJSON")},find:function(fn){return _.find(this._models,fn)},filter:function(fn){return _.filter(this._models,fn)},size:function(){return this._models.length},map:function(fn,ctx){return _.map(this._models,function(model){return fn.call(ctx,model.toJSON())})},pluck:function(field){return this.map(function(m){return m[field]})}}),module.exports=BaseCollection},function(module,exports,__webpack_require__){!function(){var App=__webpack_require__(7);window.forio=window.forio||{},window.forio.MultiplayerAssignmentComponent=App}()},function(module,exports,__webpack_require__){"use strict";function setEnvironment(options){env.set(_.omit(options,"el"))}var UsersCollection=__webpack_require__(8);var WorldsCollection=__webpack_require__(9);var ProjectModel=__webpack_require__(11);var AssignemntRow=__webpack_require__(12).default;var env=__webpack_require__(3);var AjaxQueue=__webpack_require__(13);var Assignment=function(options){setEnvironment(options),this.initialize(options)};Assignment.prototype={initialize:function(options){this.el="string"==typeof options.el?$(options.el)[0]:options.el,this.$el=$(this.el),this.$=_.partialRight($,this.el),this.users=new UsersCollection,this.worlds=new WorldsCollection,this.project=new ProjectModel,_.bindAll(this,["render","renderTable","toggleControlls","saveEdit","selectAll","usassignSelected","_showUpdating","_hideUpdating","autoAssignAll","makeUserInactive"]),this.bindEvents()},bindEvents:function(){this.$el.on("update","tr",this.saveEdit),this.$el.on("click","input:checkbox:not(#select-all)",this.toggleControlls),this.$el.on("click","#select-all",this.selectAll),this.$el.on("click",".unassign-user",this.usassignSelected),this.$el.on("click",".auto-assign-all",this.autoAssignAll),this.$el.on("click",".make-user-inactive",this.makeUserInactive)},load:function(){var join=function(){this.worlds.setUsersCollection(this.users),this.worlds.joinUsers(),this.render()}.bind(this);return $.when(this.worlds.fetch(),this.users.fetch(),this.project.fetch()).then(join)},saveEdit:function(){this.worlds.fetch().then(function(){this.worlds.joinUsers(),this.render(),this.updateControls()}.bind(this))},autoAssignAll:function(){this._showUpdating();var maxUsers=+this.$("#max-users").val();return this.worlds.autoAssignAll({maxUsers:maxUsers}).then(this._hideUpdating).fail(this._hideUpdating).then(function(){this.worlds.joinUsers(),this.render()}.bind(this))},getSelectedIds:function(){return this.$("tbody :checkbox:checked").map(function(){return $(this).data("id")}).get()},findRowViews:function(ids){var _this=this;return ids.map(function(id){return _this.rowViews[id]})},unassignUsers:function(ids){var _this2=this;var dtd=$.Deferred();var done=function(){dtd.resolve()};var queue=new AjaxQueue;return ids.forEach(function(userId){var user=_this2.users.getById(userId);user.set("world",""),user.set("role",""),queue.add(_.partial(_.bind(_this2.worlds.updateUser,_this2.worlds),user))}),queue.execute(this).then(done),dtd.promise()},usassignSelected:function(e){e.preventDefault();var ids=this.getSelectedIds();var done=function(){this.worlds.fetch().then(function(){this.worlds.joinUsers(),this._hideUpdating(),this.render()}.bind(this))}.bind(this);return this._showUpdating(),this.unassignUsers(ids).then(done)},makeUserInactive:function(e){e.preventDefault();var ids=this.getSelectedIds();var done=function(){this.toggleControlls()}.bind(this);var makeUsersInactive=function(){var rows=this.findRowViews(ids);var queue=new AjaxQueue;rows.forEach(function(view){var user=view.model;queue.add(function(){return view.makeInactive().then(function(){user.remove(),view.remove()})})}),queue.execute(this).then(done)}.bind(this);return this.unassignUsers(ids).then(makeUsersInactive)},render:function(){this.$("table tbody").empty(),this.sortTable(),this.renderTable(),this.toggleControlls()},sortTable:function(){var params=this.getTableParams();var mult=params.hasOwnProperty("direction")&&"desc"===params.direction?-1:1;var nameDirection=params.hasOwnProperty("sort")&&"name"===params.sort&&mult>0?"desc":"asc";var userNameDirection=params.hasOwnProperty("sort")&&"userName"===params.sort&&mult>0?"desc":"asc";if(this.$("table .header-name a").prop("href","?sort=name&direction="+nameDirection),this.$("table .header-username a").prop("href","?sort=userName&direction="+userNameDirection),params.hasOwnProperty("sort")){this.users.sortFn=function(a,b){var an=a.get(params.sort)||"";var bn=b.get(params.sort)||"";return"name"===params.sort&&(an=a.get("firstName")+a.get("lastName"),bn=b.get("firstName")+b.get("lastName")),mult*an.localeCompare(bn)},this.users.sort();var header="name"===params.sort?this.$("table .header-name"):this.$("table .header-username");var arrowDir=mult>0?"caret-up":"caret-down";var arrow=this.$("<span class="+arrowDir+"></span>");header.append(arrow)}},getTableParams:function(){var query=""!==location.search?location.search.substr(1).split("&"):[];var params={};for(var i=0;i<query.length;i++){var q=query[i].split("=");params[q[0]]=q[1]}return params},renderTable:function(){var _this3=this;this.rowViews={};var rows=[];this.users.each(function(u){var view=new AssignemntRow({model:u,worlds:_this3.worlds,project:_this3.project});_this3.rowViews[u.get("id")]=view,rows.push(view.render().el)}),this.$("table tbody").append(rows)},updateControls:function(){this.updateControlsForSelection(),this.updateAutoAssignButton(),this.updateStatus()},updateStatus:function(){var incompleteWorlds=this.worlds.getIncompleteWorldsCount();var unassignedUsers=this.users.getUnassignedUsersCount();var totalWorlds=this.worlds.size();var usersText="All users have been assigned.";unassignedUsers&&(usersText=1===unassignedUsers?"1 user needs assignment.":unassignedUsers+" users need assignment.");var worldsText="All worlds are complete.";totalWorlds?incompleteWorlds&&(worldsText=1===incompleteWorlds?"1 incomplete world needs attention.":incompleteWorlds+" incomplete worlds need attention."):worldsText="No worlds have been created.",this.$("#users-status .text").text(usersText),this.$("#worlds-status .text").text(worldsText),unassignedUsers?this.$("#users-status").addClass("incomplete"):this.$("#users-status").removeClass("incomplete"),incompleteWorlds||!totalWorlds?this.$("#worlds-status").addClass("incomplete"):this.$("#worlds-status").removeClass("incomplete"),this.$(".status-widget").addClass("visible")},updateControlsForSelection:function(){var numSelected=this.$("tbody :checkbox:checked").length;this.$(".component.controls")[numSelected?"addClass":"removeClass"]("visible")},updateAutoAssignButton:function(){if(this.project.isDynamicAssignment()){var hasRoles=this.project.hasRoles();this.$(".table-controls .single").hide(),this.$(".table-controls .dynamic").show(),this.$(".table-controls .dynamic-no-roles-text")[hasRoles?"hide":"show"](),this.$(".table-controls .no-roles")[hasRoles?"hide":"show"]()}else this.$(".table-controls .dynamic").hide(),this.$(".table-controls .dynamic-no-roles-text").hide(),this.$(".table-controls .single").show(),this.$(".table-controls .no-roles").show();this.users.allUsersAssigned()?this.$(".table-controls").removeClass("visible"):this.$(".table-controls").addClass("visible")},selectAll:function(e){this.$("tbody :checkbox").prop("checked",e.target.checked),this.updateControls()},toggleControlls:function(e){var total=this.$("tbody :checkbox");var checked=this.$("tbody :checkbox:checked");total.length===checked.length?this.$("#select-all").attr("checked","checked"):this.$("#select-all").removeAttr("checked"),this.updateControls()},_showUpdating:function(){this.$el.css({opacity:.4})},_hideUpdating:function(){this.$el.css({opacity:1})}},module.exports=Assignment},function(module,exports,__webpack_require__){"use strict";var classFrom=__webpack_require__(0);var Model=__webpack_require__(4);var Base=__webpack_require__(5);var env=__webpack_require__(3);var serviceLocator=__webpack_require__(1);module.exports=classFrom(Base,{model:Model,sortFn:function(a,b){var aw=a.get("world").toLowerCase();var bw=b.get("world").toLowerCase();return aw!==bw?aw<bw?-1:1:b.get("userName")>a.get("userName")?-1:1},initialize:function(){var am=new F.manager.AuthManager;var session=am.getCurrentUserSessionInfo();var token=session.auth_token;token&&$.ajaxSetup({headers:{Authorization:"Bearer "+token}})},allUsersAssigned:function(){return this.all(function(u){return!!u.get("world")})},getUnassignedUsersCount:function(){return this.filter(function(u){return!u.get("world")}).length},fetch:function(){var dtd=$.Deferred();var me=this;var groupId=env.get().groupId;return function(){var memberApi=serviceLocator.memberApi();var userApi=serviceLocator.userApi();var splitIdChunks=function(userIds){var idGroups=[];for(;userIds.length>=100;)idGroups.push(userIds.splice(0,100));return userIds.length&&idGroups.push(userIds),idGroups};var loadUsersInfo=function(group){var nonFacAndActive=function(u){return u.active&&"facilitator"!==u.role};var endUsers=group.members.filter(function(m){return nonFacAndActive(m)});var endUserIds=endUsers.map(function(u){return u.userId});var chunkedUsers=splitIdChunks(endUserIds);var chunkedPromises=chunkedUsers.map(function(users){return userApi.get({id:users})});return $.when.apply($,chunkedPromises).then(function(userGroups){return userGroups.reduce(function(acc,userGroup){return acc.concat(userGroup)},[])})};return function(){return memberApi.getGroupDetails()}().then(loadUsersInfo).fail(dtd.reject)}().then(function(users){users=users.map(function(u){return $.extend(u,{groupId:groupId})}),me.set(users),dtd.resolve(users)}),dtd.promise()}})},function(module,exports,__webpack_require__){"use strict";var classFrom=__webpack_require__(0);var Model=__webpack_require__(10);var UserModel=__webpack_require__(4);var serviceLocator=__webpack_require__(1);var Base=__webpack_require__(5);var __super=Base.prototype;var doneFn=function(dtd,after){return _.after(after,dtd.resolve)};var worldApi;module.exports=classFrom(Base,{model:Model,initialize:function(){__super.initialize.apply(this,arguments),worldApi=serviceLocator.worldApi()},autoAssignAll:function(options){return worldApi.autoAssign(options).then(function(worlds){this.reset(this.parse(worlds))}.bind(this))},getIncompleteWorldsCount:function(){return this.filter(function(w){return!w.get("complete")}).length},updateUser:function(user){var worldName=user.get("world");var dtd=$.Deferred();var prevWorld=this.getWorldByUser(user);var curWorld=this.getOrCreateWorld(worldName);var done=doneFn(dtd,1);return prevWorld||curWorld?(prevWorld?prevWorld.removeUser(user).then(function(){if(curWorld)return curWorld.addUser(user)}).then(done):curWorld&&curWorld.addUser(user).then(done),dtd.promise()):dtd.resolve().promise()},getOrCreateWorld:function(worldName){if(worldName){var world=this.getWordByName(worldName);return world||(world=this.create({name:worldName})),world}},getWordByName:function(worldName){return this.find(function(world){return world.get("name")===worldName})},getWorldByUser:function(user){if(!user.get)throw new Error("getWorldByUser expectes a model ("+user+")");var id=user.get("id");return this.getWorldByUserId(id)},getWorldByUserId:function(userId){return this.find(function(world){return _.find(world.get("users"),function(u){return u.get("id")===userId})})},getWorldNames:function(){return this.pluck("name").sort()},getNextWorldName:function(){var worlds=this.getWorldNames();if(!worlds.length)return"World001";var properNames=_.filter(worlds,function(w){return/World\d\d\d/.test(w)}).sort();var lastWorld=properNames[properNames.length-1];var numWorld=+lastWorld.match(/World(\d\d\d)/)[1];return"World"+function(num,places){var zeros="000000000000000000";var digits=num.toString().length;var needed=places-digits;return zeros.substr(0,needed)+num}(numWorld+1,3)},setUsersCollection:function(usersCollection){this.usersCollection=usersCollection},joinUsers:function(){var usersHash={};var usersCollection=this.usersCollection;usersCollection.each(function(u){return u.set({isWorldComplete:!0}),usersHash[u.get("id")]=u}),this.each(function(w,i){var name=w.get("name");var isComplete=w.get("complete");w.set({index:i,name:name||i+1+""}),_.each(w.get("users"),function(u){usersHash[u.get("userId")]&&usersHash[u.get("userId")].set({world:name,role:u.get("role"),isWorldComplete:isComplete})})}),usersCollection.sort()},fetch:function(){return worldApi.list().then(function(worlds){this.reset(this.parse(worlds))}.bind(this))},parse:function(worlds){return worlds.length&&(worlds=_.map(worlds,function(w){var users=_.map(w.users,function(u){return u.id=u.userId,new UserModel(u)});return w.users=users,w})),worlds}})},function(module,exports,__webpack_require__){"use strict";var serviceLocator=__webpack_require__(1);var classFrom=__webpack_require__(0);var Base=__webpack_require__(2);var __super=Base.prototype;module.exports=classFrom(Base,{defaults:{users:null,model:"model.eqn"},initialize:function(){__super.initialize.apply(this,arguments),this._data.users=this._data.users||[],this._worldApi=serviceLocator.worldApi();var id=this.get("id");id&&this._worldApi.updateConfig({filter:id})},addUser:function(user){return this.get("users").push(user),this.save()},removeUser:function(user){var id=this.get("id");var checkWorld=function(){if(!this.get("users").length)return this.remove(),this._worldApi.updateConfig({filter:id}).delete()}.bind(this);return _.remove(this.get("users"),function(u){return u.get("id")===user.get("id")}),this._worldApi.updateConfig({filter:id}).removeUser({userId:user.get("id")}).then(checkWorld)},save:function(){var me=this;var mapUsers=function(){return _.map(this.get("users"),function(u){var res={userId:u.get("id")};var role=u.get("role");return role&&(res.role=role),res})}.bind(this);var createWorld=_.partial(this._worldApi.create,this.pick(["model","name","minUsers"]));var addUsers=_.partial(me._worldApi.addUsers,mapUsers(),{filter:me.get("id")});var savedUsers=this.get("users");return this.isNew()?createWorld().then(function(world){me.set(world),me._worldApi.updateConfig({filter:world.id})}).then(addUsers).then(function(users){me.set("users",savedUsers)}):addUsers()},isNew:function(){return!this.get("lastModified")}})},function(module,exports,__webpack_require__){"use strict";var serviceLocator=__webpack_require__(1);var classFrom=__webpack_require__(0);var Base=__webpack_require__(2);module.exports=classFrom(Base,{isDynamicAssignment:function(){return"dynamic"===this.get("worlds")},hasRoles:function(){var roles=this.get("roles");return roles&&!!roles.length},fetch:function(){return serviceLocator.worldApi().getProjectSettings().then(function(settings){this.set(settings)}.bind(this))}})},function(module,__webpack_exports__,__webpack_require__){"use strict";Object.defineProperty(__webpack_exports__,"__esModule",{value:!0});var userRowTemplate='\n    <td><input type="checkbox" class="select" data-id="<%= id%>"</td>\n    <td><%= !isWorldComplete ? \'<em class="f-icon f-warning"></em>\' : \'\' %></td>\n    <td><%= world %></td>\n    <td><%= role %></td>\n    <td><%= lastName %></td>\n    <td><%= userName %></td>\n    <td><%= !world ? \'<em class="f-icon f-warning"></em>\' : \'\' %></td>\n    <td class="actions"><button class="btn edit btn-edit btn-tools auto-hide">Edit</button></td>\n'.trim();var AssignmentRow=function(options){this.$el=$("<tr>"),this.el=this.$el[0],this.$=_.partialRight($,this.$el),this.model=options.model,this.options=options,this.worlds=options.worlds,this.project=options.project,_.bindAll(this,["setEditMode","removeEditMode","saveEdit","cancelEdit","updateData"]),this.bindEvents()};_.extend(AssignmentRow.prototype,{template:_.template(userRowTemplate),editTemplate:_.template('\n    <td><input type="checkbox" class="select" data-id="<%= id %>"</td>\n    <td></td>\n    <td>\n        <select name="worlds" class="form-control" data-field="world">\n\n        <% _.each(worlds, function (w) { %>\n            <option value="<%= w %>" <%= w === world ? \'selected\' : \'\' %>><%= w %></option>\n        <% }); %>\n            <option value="<%= newWorld %>" class="new-world-text"><i><%= newWorld %> - New -</i></option>\n        </select>\n    </td>\n    <td>\n        <select name="roles" class="form-control" data-field="role">\n        <% _.each(roles, function (r) { %>\n            <option value="<%= r %>" <%= r === role ? \'selected\' : \'\' %>><%= r %></option>\n        <% }); %>\n\n        <% _.each(optionalRoles, function (r) { %>\n            <option value="<%= r %>" <%= r === role ? \'selected\' : \'\' %>><%= r %> <i>(Optional)</i></option>\n        <% }); %>\n        </select>\n    </td>\n    <td><%= lastName %></td>\n    <td><%= userName %></td>\n    <td><%= !world ? \'<em class="f-icon f-warning"></em>\' : \'\' %></td>\n    <td class="actions">\n        <button class="btn btn-primary btn-tools btn-save save">Save</button>\n        <button class="btn btn-tools btn-cancel cancel">Cancel</button>\n    </td>\n'),bindEvents:function(){this.$el.on("click","button.edit",this.setEditMode),this.$el.on("click","button.save",this.saveEdit),this.$el.on("click","button.cancel",this.cancelEdit)},remove:function(){this.$el.off("click",null,null),this.$(":checkbox").attr("checked",!1),this.$el.css({opacity:.3}).animate({height:0},{duration:300,complete:function(){this.remove()}})},makeInactive:function(){return this.model.makeInactive()},setEditMode:function(){this.model.set("edit-mode",!0),this.render()},removeEditMode:function(){this.model.set("edit-mode",!1),this.render()},saveEdit:function(){var me=this;this.updateData(),this.worlds.updateUser(this.model).then(function(){me.removeEditMode(),me.$el.trigger("update",me)})},cancelEdit:function(){this.removeEditMode()},render:function(){var templ=this.model.get("edit-mode")?this.editTemplate:this.template;var vm=_.extend({roles:this.project.get("roles"),optionalRoles:this.project.get("optionalRoles"),worlds:this.worlds.getWorldNames(),newWorld:this.worlds.getNextWorldName()},this.model.toJSON());return this.$el.html(templ(vm)),this},updateData:function(){var me=this;this.$("[data-field]").each(function(){var el=$(this);var field=el.data("field");var val=el.val();me.model.set(field,val)})}}),__webpack_exports__.default=AssignmentRow},function(module,exports,__webpack_require__){"use strict";function AjaxQueue(){this.queue=[]}$.extend(AjaxQueue.prototype,{add:function(fn){return this.queue.push(fn)},execute:function(context){function next(){if(me.queue.length){me.queue.shift().call(context).then(next).fail(dtd.reject)}else dtd.resolve()}var dtd=$.Deferred();var me=this;return context=context||this,next(),dtd.promise()}}),module.exports=AjaxQueue}]);
//# sourceMappingURL=assignment.min.js.map