<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Epicenter JS libs Playground</title>
</head>
<body data-f-model="model.eqn">

    <script src="vendor/underscore/underscore.js"></script>

    <!-- include source files here... -->
    <script src="../vendor/jquery/dist/jquery.min.js"></script>
    <script src="../dist/epicenter-multiplayer-dependencies.js"></script>
    <script src="../dist/epicenter-edge.js"></script>
    <script src="https://forio.com/tools/js-libs/flow/0.11.0/flow.min.js"></script>
    <!-- <script src="https://forio.com/tools/js-libs/1.7.1/epicenter.min.js"></script> -->
    <script>
        'use strict';
        // var authMgr = new F.manager.AuthManager();
        // authMgr.login({
        //       account: 'acme-simulations-0', 
        //       userName: 'userFOnly', //an end user in one group
        //       password: 'passw0rd',
        //       project: 'hello_world_python'
        //   })
        //     .then(function(authAdapter) {
        //         console.log(authMgr.getCurrentUserSessionInfo());
        //         // var rm =  new F.manager.RunManager({
        //         //   strategy: 'persistent-single-player',
        //         //   run: { model: 'hello_world.py', account: 'acme-simulations-0', project: 'hello_world_python' }
        //         // });

        //         // rm.reset().then(function(run) { 
        //         //   console.log('run = ', run); 
        //         //   var vs = rm.run.variables();
        //         //   vs.load('sample_int').then(function(val){ console.log(val); });
        //         // })
        //         // .fail(function(data) { console.log('failed, data = ', data); });

        //   });
        // Flow.initialize({
        //     channel: {
        //         strategy: 'new-if-persisted',
        //         run: {
        //             account: 'forio-dev',
        //             project: 'wharton-edp'
        //         }
        //     }
        // });
        // $(document).ajaxError((event, jqxhr, settings, thrownError)=> {
        //     const BAD_REQUEST = 400;
        //     const SERVER_ERROR = 500;
        //     const epiMatcher = /\/(?:run)\/[^\/]+\/[^\/]+/;
        //     if (epiMatcher.exec(settings.url) && jqxhr.status >= BAD_REQUEST && jqxhr.status < SERVER_ERROR) {
        //         console.log('redirect to login');
        //     }
        // });
        var authMgr = new F.manager.AuthManager();


  authMgr.login({
      account: 'acme-simulations-0', 
      //userName: 'user2',  //many groups
      userName: 'user3', //many groups
      //userName: 'userFOnly', //one group
      password: 'passw0rd',
      project: 'hello_world_python',
      //groupId: 'b0315d47-fb61-46bc-ad14-5e418638bd12' // js-libs-team2
      groupId: '80257a25-aa10-4959-968b-fd053901f72f'
  })
    .then(function(authAdapter) {
          console.log("one group");

          var tmp = authMgr.getCurrentUserSessionInfo();
          console.log(tmp);
          // if enduser1 belongs to exactly one group
          // (or if the login() call is modified to include the group)
          // continue here
          
          var store = authMgr.sessionManager;
          console.log("before creating run, store = ", store.getStore().serviceOptions.cookie.get());
        

         
        var rm =  new F.manager.RunManager({ 
          //strategy: 'always-new', 
          //strategy: 'persistent-single-player',
          strategy: 'new-if-persisted',
          run: { 
              model: 'hello_world.py', 
              account: 'acme-simulations-0', 
              project: 'hello_world_python', 
              //scope: { group: 'js-libs-team2' }
          }
        });
        //rm.reset().then(function(run) { console.log('run = ', run); }).fail(function(data) { console.log('failed, data = ', data); });
        rm.getRun().then(function(run) { 
          console.log('run = ', run); 
          var vs = rm.run.variables();
          vs.load('sample_int').then(function(val){ console.log(val); });

         console.log("after getting run, store = ", store.getStore().serviceOptions.cookie.get());

          console.log("now, logging out");
          authMgr.logout(); 

        })
        .fail(function(data) { console.log('failed, data = ', data); });
        



  }).fail(function(msg) { console.log('login failed, msg = ', msg); });
    </script>
</body>
</html>
