'use strict';

var epiVersion = require('../api-version.json');

//TODO: urlutils to get host, since no window on node
var defaults = {
    host: window.location.host,
    pathname: window.location.pathname
};

var UrlConfigService = function (config) {
    var options = $.extend({}, defaults, config);
    function isLocalhost() {
        var isLocal = !options.host || //phantomjs
            options.host === '127.0.0.1' || 
            options.host.indexOf('local.') === 0 || 
            options.host.indexOf('localhost') === 0;
        return isLocal;
    }

    var API_PROTOCOL = 'https';
    var HOST_API_MAPPING = {
        'forio.com': 'api.forio.com',
        'foriodev.com': 'api.epicenter.foriodev.com'
    };

    var publicExports = {
        protocol: API_PROTOCOL,

        api: '',

        host: (function () {
            var host = options.host;
            if (isLocalhost()) {
                host = 'forio.com';
            }
            return (HOST_API_MAPPING[host]) ? HOST_API_MAPPING[host] : 'api.' + host;
        }()),

        appPath: (function () {
            var path = options.pathname.split('\/');

            return path && path[1] || '';
        }()),

        accountPath: (function () {
            var accnt = '';
            var path = options.pathname.split('\/');
            if (path && path[1] === 'app') {
                accnt = path[2];
            }
            return accnt;
        }()),

        projectPath: (function () {
            var prj = '';
            var path = options.pathname.split('\/');
            if (path && path[1] === 'app') {
                prj = path[3]; //eslint-disable-line no-magic-numbers
            }
            return prj;
        }()),

        versionPath: (function () {
            var version = epiVersion.version ? epiVersion.version + '/' : '';
            return version;
        }()),

        isLocalhost: isLocalhost,

        getAPIPath: function (api) {
            var PROJECT_APIS = ['run', 'data', 'file'];

            var apiPath = this.protocol + '://' + this.host + '/' + this.versionPath + api + '/';

            if ($.inArray(api, PROJECT_APIS) !== -1) {
                apiPath += this.accountPath + '/' + this.projectPath + '/';
            }
            return apiPath;
        }
    };

    // This data is set by an external script (start-load.js)
    var envConf = {
        protocol: UrlConfigService.protocol,
        host: UrlConfigService.host
    };

    $.extend(publicExports, envConf, config);
    return publicExports;
};

module.exports = UrlConfigService;
